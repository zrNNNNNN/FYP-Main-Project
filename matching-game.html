<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Matching Puzzle — SEG Open House</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
  :root{
    --bg1:#0f172a; --bg2:#1e293b;
    --card-bg: rgba(255,255,255,0.04);
    --accent-500:#2563eb;
    --accent-400:#3b82f6;
    --muted:#9aa6c0;
    --success:#10b981;
    --danger:#ef4444;
    --card-radius:16px;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family:"Poppins",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    color:#e6eef8;
    background: linear-gradient(135deg,var(--bg1),var(--bg2));
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    padding:20px;
    display:flex;
    justify-content:center;
  }

  .stage{width:100%;max-width:980px;}

  header{
    display:flex;
    gap:16px;
    align-items:stretch;
    margin-bottom:18px;
    flex-wrap:wrap;
    justify-content:space-between;
  }

  .hero{
    flex:1;
    background: linear-gradient(90deg, rgba(59,130,246,0.06), rgba(37,99,235,0.03));
    border-radius:12px;
    padding:16px;
    box-shadow: 0 6px 20px rgba(2,6,23,.06);
    display:flex;
    align-items:center;
    gap:14px;
    min-width:0;
  }

  .logo{
    width:56px;height:56px;border-radius:12px;
    display:flex;align-items:center;justify-content:center;
    background:linear-gradient(135deg,var(--accent-500),var(--accent-400));
    color:white;font-weight:700;font-size:20px;
    box-shadow: 0 6px 18px rgba(59,130,246,0.18);
    flex:0 0 56px;
  }

  .hero-text h1{margin:0;font-size:1.1rem}
  .hero-text p{margin:4px 0 0;color:var(--muted);font-size:.9rem}

  #timerBox{
    background: rgba(15,23,42,0.85);
    border-radius:12px;
    padding:10px 14px;
    display:flex;
    flex-direction:column;
    justify-content:center;
    align-items:flex-start;
    min-width:130px;
    box-shadow:0 8px 26px rgba(2,6,23,0.6);
    border:1px solid rgba(148,163,184,0.2);
  }
  #timerLabel{font-size:.8rem;color:var(--muted);}
  #timer{
    font-size:1.3rem;
    font-weight:700;
    color:#22c55e;
  }
  #timerBox.warning #timer{color:#facc15;}
  #timerBox.danger #timer{color:#fb7185;}

  main{margin-top:4px;display:block;}

  .card{
    background:var(--card-bg);
    border-radius:var(--card-radius);
    padding:16px;
    box-shadow: 0 14px 44px rgba(2,6,23,.28);
    border:1px solid rgba(255,255,255,0.03);
  }

  .top-bar{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
    flex-wrap:wrap;
    margin-bottom:10px;
  }
  #levelLabel{font-size:.95rem;color:var(--muted);}
  #streakBadge{
    font-size:.85rem;
    padding:4px 8px;
    border-radius:999px;
    background:rgba(34,197,94,0.12);
    color:#bbf7d0;
    border:1px solid rgba(34,197,94,0.3);
    opacity:0;
    transform:translateY(6px);
    transition:opacity .2s ease, transform .2s ease;
  }
  #streakBadge.show{
    opacity:1;
    transform:translateY(0);
  }

  .board{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:14px;
    margin-top:6px;
  }
  @media (max-width:780px){
    .board{grid-template-columns:1fr;}
    header{flex-direction:column;}
    #timerBox{align-self:flex-start;}
  }

  .pane{
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-radius:12px;padding:12px;
    border:1px solid rgba(255,255,255,0.04);
  }
  .pane h2{margin:0 0 8px;font-size:.98rem;color:#e6f0ff;}
  .list{display:flex;flex-direction:column;gap:8px;}

  .item{
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:10px 12px;
    border-radius:10px;
    border:1px solid rgba(148,163,184,0.25);
    background: radial-gradient(circle at top left, rgba(148,163,184,0.16), rgba(15,23,42,0.9));
    user-select:none;
    cursor:pointer;
    color:#e5edff;
    font-size:.92rem;
    transition: transform .1s ease, box-shadow .15s ease, border-color .15s ease, background .15s ease;
    touch-action: manipulation;
  }
  @media (hover:hover){
    .item:hover{
      transform:translateY(-1px);
      box-shadow:0 6px 16px rgba(15,23,42,0.4);
    }
  }

  .item.selected{
    outline:2px solid rgba(59,130,246,.6);
    box-shadow:0 8px 18px rgba(59,130,246,.3);
  }
  .item.matched{
    background:linear-gradient(90deg, rgba(16,185,129,0.22), rgba(6,95,70,0.9));
    border-color:rgba(16,185,129,.8);
    color:#ecfdf5;
    box-shadow:0 6px 18px rgba(16,185,129,0.4);
    cursor:default;
  }

  .item.correctFlash{ animation:correctFlash .35s ease-out; }
  .item.wrongFlash{ animation:wrongFlash .3s ease-out; }

  @keyframes correctFlash{
    0%{transform:scale(1);box-shadow:0 0 0 rgba(16,185,129,0);}
    50%{transform:scale(1.03);box-shadow:0 0 18px rgba(16,185,129,0.7);}
    100%{transform:scale(1);}
  }
  @keyframes wrongFlash{
    0%{transform:translateX(0);}
    25%{transform:translateX(-4px);}
    50%{transform:translateX(4px);}
    75%{transform:translateX(-2px);}
    100%{transform:translateX(0);}
  }

  .course-label{font-weight:600;}
  .job-main{display:flex;flex-direction:column;gap:2px;}
  .job-title{font-weight:600;font-size:.92rem;}
  .job-sub{font-size:.78rem;color:var(--muted);}

  .pill{
    font-size: .78rem;
    padding: 6px 12px;
    border-radius: 999px;
    background: rgba(15,23,42,0.85);
    border: 1px solid rgba(148,163,184,0.55);
    color: #cbd5f5;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 110px;
    text-align: center;
    white-space: nowrap;
  }

  .controls{
    display:flex;
    gap:10px;
    align-items:center;
    margin-top:12px;
    flex-wrap:wrap;
  }

  .btn{
    background:linear-gradient(180deg,var(--accent-400),var(--accent-500));
    color:white;
    padding:8px 12px;
    border-radius:8px;
    border:0;
    cursor:pointer;
    font-weight:700;
    box-shadow:0 8px 22px rgba(37,99,235,0.18);
    font-size:.9rem;
  }
  .btn.ghost{
    background:transparent;
    color:var(--accent-400);
    border:1px solid rgba(59,130,246,0.3);
    box-shadow:none;
  }

  .stats{
    margin-left:auto;
    color:var(--muted);
    font-size:.85rem;
    display:flex;
    flex-direction:column;
    align-items:flex-end;
    gap:2px;
  }
  .stats-line{white-space:nowrap;}
  #scoreValue.bump{ animation:scoreBump .25s ease-out; }
  @keyframes scoreBump{
    0%{transform:scale(1);}
    50%{transform:scale(1.2);}
    100%{transform:scale(1);}
  }
  #scoreDelta{
    font-size:.8rem;
    margin-left:4px;
    opacity:0;
    transform:translateY(-4px);
    transition:opacity .2s ease, transform .2s ease;
  }
  #scoreDelta.show{
    opacity:1;
    transform:translateY(0);
  }
  #scoreDelta.positive{color:#4ade80;}
  #scoreDelta.negative{color:#fb7185;}

  .note{
    color:var(--muted);
    font-size:.85rem;
    margin-top:10px;
  }

  #confetti { position:fixed; inset:0; pointer-events:none; z-index:60; display:none; }

  #timeUpBar{
    position:fixed;
    left:50%;
    transform:translateX(-50%);
    bottom:16px;
    background:linear-gradient(90deg,#b91c1c,#ef4444);
    color:white;
    padding:10px 16px;
    border-radius:999px;
    display:none;
    align-items:center;
    gap:10px;
    box-shadow:0 10px 30px rgba(127,29,29,0.6);
    z-index:80;
    font-size:.9rem;
  }
  #timeUpBar button{
    background:white;
    color:#b91c1c;
    border:none;
    border-radius:999px;
    padding:6px 12px;
    font-weight:700;
    cursor:pointer;
  }

  .overlay{
    position:fixed;
    inset:0;
    display:none;
    align-items:center;
    justify-content:center;
    background:linear-gradient(rgba(3,7,18,0.55),rgba(3,7,18,0.55));
    z-index:70;
  }
  .overlay.show{display:flex;}
  .modal{
    width:100%;
    max-width:460px;
    background:linear-gradient(180deg,#0b1220,#071029);
    border-radius:14px;
    padding:22px;
    text-align:center;
    box-shadow:0 30px 80px rgba(2,6,23,.6);
    border:1px solid rgba(255,255,255,0.03);
    transform:translateY(8px);
    opacity:0;
    transition:transform .28s cubic-bezier(.2,.9,.2,1),opacity .18s;
  }
  .overlay.show .modal{
    transform:translateY(0);
    opacity:1;
  }
  .modal h3{
    margin:0;
    font-size:1.18rem;
    color:#ffd166;
  }
  .modal p{
    color:var(--muted);
    margin-top:8px;
  }
  .modal .key{
    width:96px;height:96px;
    margin:16px auto 8px;
    border-radius:16px;
    display:flex;
    align-items:center;
    justify-content:center;
    background:linear-gradient(135deg,#ffd166,#f4a261);
    box-shadow:0 12px 28px rgba(244,162,97,0.12);
  }

  #forging{
    position:fixed;
    inset:0;
    display:none;
    align-items:center;
    justify-content:center;
    z-index:75;
    pointer-events:none;
  }
  #forging .box{
    width:320px;
    max-width:92%;
    background:linear-gradient(180deg,#071029,#081424);
    color:white;
    padding:18px;
    border-radius:12px;
    text-align:center;
    box-shadow:0 14px 40px rgba(2,6,23,.6);
    border:1px solid rgba(255,255,255,0.03);
  }
  .forge-bar{
    height:10px;
    background: rgba(255,255,255,0.06);
    border-radius:999px;
    overflow:hidden;
    margin-top:12px;
  }
  .forge-fill{
    height:100%;
    width:0%;
    background: linear-gradient(90deg,#ffd166,#f4a261);
    transition: width 1.2s ease;
  }

  @media (max-width:640px){
    body{padding:14px;}
    .logo{width:48px;height:48px;}
    .hero-text h1{font-size:1rem;}
    .hero-text p{font-size:.85rem;}
    .stats{align-items:flex-start;margin-left:0;}
  }
</style>
</head>
<body>
<div class="stage">
  <header>
    <div class="hero">
      <div class="logo">SEG</div>
      <div class="hero-text">
        <h1 id="headerTitle">Match the Courses to Its Future Job Prospects (Level 1)</h1>
        <p>Complete all <strong>2 levels</strong> within 4 minutes to collect <strong>Key #1</strong>.</p>
      </div>
    </div>
    <div id="timerBox">
      <span id="timerLabel">Time Left</span>
      <span id="timer">4:00</span>
    </div>
  </header>

  <main>
    <section class="card">
      <div class="top-bar">
        <div id="levelLabel">Level 1 of 2</div>
        <div id="streakBadge">Streak bonus active!</div>
      </div>

      <div class="board" aria-label="Matching board">
        <div class="pane" id="coursesPane">
          <h2 id="coursesTitle">Courses</h2>
          <div class="list" id="coursesList" aria-live="polite"></div>
        </div>

        <div class="pane" id="jobsPane">
          <h2 id="jobsTitle">Future Job Prospects</h2>
          <div class="list" id="jobsList" aria-live="polite"></div>
        </div>
      </div>

      <div class="controls">
        <button id="resetBtn" class="btn ghost" aria-label="Reset game">Reset</button>
        <div class="message small" id="hint">Tap a course (left) then a job (right) to try a match.</div>
        <div class="stats" aria-live="polite">
          <div class="stats-line">
            <strong>Score:</strong>
            <span id="scoreValue">0</span>
            <span id="scoreDelta"></span>
          </div>
          <div class="stats-line">
            Streak: <span id="streakValue">0</span> &nbsp;•&nbsp;
            Matches: <span id="matchedCount">0</span>/<span id="matchesTotal">0</span>
          </div>
          <div class="stats-line">
            Attempts: <span id="attempts">0</span>
          </div>
        </div>
      </div>

      <p class="note" id="scoringNote"></p>
    </section>
  </main>
</div>

<canvas id="confetti"></canvas>

<div id="timeUpBar">
  <span>Time's up! Restart from Level 1 to try again.</span>
  <button id="restartBtn">Restart</button>
</div>

<div id="forging" aria-hidden="true">
  <div class="box">
    <div style="font-weight:700;color:#ffd166;">Forging Key #1...</div>
    <div class="small" style="margin-top:6px;color:#9aa6c0;">Hang on — almost done</div>
    <div class="forge-bar"><div class="forge-fill" id="forgeFill"></div></div>
  </div>
</div>

<div id="finalOverlay" class="overlay" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal" role="document">
    <div class="key" aria-hidden="true">
      <svg width="56" height="56" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <linearGradient id="k1" x1="0" x2="1">
            <stop offset="0" stop-color="#ffd166"/><stop offset="1" stop-color="#f4a261"/>
          </linearGradient>
        </defs>
        <path d="M44 24a12 12 0 1 0-8.485 11.314L43 31.828V36h4v6h-4v4h-4v-4h-4v4h-6l-9 9v-6H8v-8h8v-6h6v-6l2-2.001A12 12 0 0 0 44 24z" fill="url(#k1)"/>
      </svg>
    </div>
    <h3>Key #1 Received!</h3>
    <p>Your final score is <strong><span id="finalScore">0</span></strong>.</p>
    <p>Your longest streak was <strong><span id="finalStreak">0</span></strong> correct in a row.</p>
    <p>Great! Screenshot this page to claim your prize at Level 1.</p>
    <div style="margin-top:14px;display:flex;gap:10px;justify-content:center;">
      <button id="finalClose" class="btn ghost" aria-label="Close">Close</button>
    </div>
  </div>
</div>

<script>
/* =========================
   COURSE BANK (from your list)
   Each course has exactly 2 correct jobs
   ========================= */
const courseBank = [
  {
    name: "Advanced & Digital Manufacturing",
    jobs: [
      { title: "Assistant Software Engineer", sub: "" },
      { title: "Automation Test Engineer", sub: "" }
    ]
  },
  {
    name: "Aerospace Engineering",
    jobs: [
      { title: "Unmanned Aerial Systems Engineer", sub: "" },
      { title: "Avionics Systems Development", sub: "" }
    ]
  },
  {
    name: "Biomedical Engineering",
    jobs: [
      { title: "QA Technical Specialist", sub: "" },
      { title: "Laboratory Technologist", sub: "" }
    ]
  },
  {
    name: "Cloud Engineering",
    jobs: [
      { title: "Network Engineer", sub: "" },
      { title: "Software/DevOps Engineer", sub: "" }
    ]
  },
  {
    name: "Robotics & Mechatronics",
    jobs: [
      { title: "R&D Associate Engineer", sub: "" },
      { title: "System Development Engineer", sub: "" }
    ]
  },
  {
    name: "Electric & Computer Engineering",
    jobs: [
      { title: "Cybersecurity Specialist", sub: "" },
      { title: "Hardware/Software Engineer", sub: "" }
    ]
  },
  {
    name: "AI & Data Engineering",
    jobs: [
      { title: "Data Engineer/Technician", sub: "" },
      { title: "AI Application Developer", sub: "" }
    ]
  },
  {
    name: "Engineering With Business",
    jobs: [
      { title: "Operations Integration Specialist", sub: "" },
      { title: "Business Process Excellence Engineer", sub: "" }
    ]
  }
];

const TOTAL_LEVELS = 2;

/* =========================
   UTIL
   ========================= */
function shuffle(arr){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]] = [a[j],a[i]];
  }
  return a;
}

/* =========================
   BUILD 2 RANDOM LEVELS
   - Pick 5 courses randomly each new play
   - Level 1: 2 courses -> 4 jobs (2 jobs per course)
   - Level 2: 3 courses -> 6 jobs (2 jobs per course)
   ========================= */
function generateLevels(){
  const picked = shuffle(courseBank).slice(0, 5);
  const level1Courses = picked.slice(0, 2);
  const level2Courses = picked.slice(2, 5);

  const L1 = buildLevel({
    levelId: 1,
    coursesRaw: level1Courses,
    streakTarget: 4,
    multiplier: 1.5
  });

  const L2 = buildLevel({
    levelId: 2,
    coursesRaw: level2Courses,
    streakTarget: 6,
    multiplier: 2.0
  });

  return [L1, L2];
}

function buildLevel({ levelId, coursesRaw, streakTarget, multiplier }){
  const courseObjs = coursesRaw.map((c, i) => ({
    id: `L${levelId}_C${i}_${Math.random().toString(16).slice(2)}`,
    name: c.name,
    jobs: c.jobs.map((j, k) => ({
      id: `L${levelId}_J${i}${k}_${Math.random().toString(16).slice(2)}`,
      title: j.title,
      sub: j.sub || ""
    }))
  }));

  const matchPairs = [];
  courseObjs.forEach(c => c.jobs.forEach(j => matchPairs.push(`${c.id}|${j.id}`)));

  return {
    id: levelId,
    titleSuffix: `(Level ${levelId})`,
    courses: shuffle(courseObjs),
    jobs: shuffle(courseObjs.flatMap(c => c.jobs)),
    matchSet: new Set(matchPairs),
    totalMatches: matchPairs.length,
    streakTarget,
    multiplier
  };
}

/* =========================
   DOM ELEMENTS
   ========================= */
const coursesList = document.getElementById('coursesList');
const jobsList = document.getElementById('jobsList');
const matchedCountEl = document.getElementById('matchedCount');
const matchesTotalEl = document.getElementById('matchesTotal');
const attemptsEl = document.getElementById('attempts');
const scoreEl = document.getElementById('scoreValue');
const scoreDeltaEl = document.getElementById('scoreDelta');
const streakEl = document.getElementById('streakValue');
const levelLabelEl = document.getElementById('levelLabel');
const headerTitleEl = document.getElementById('headerTitle');
const streakBadge = document.getElementById('streakBadge');
const scoringNoteEl = document.getElementById('scoringNote');

const resetBtn = document.getElementById('resetBtn');
const confettiCanvas = document.getElementById('confetti');
const timeUpBar = document.getElementById('timeUpBar');
const restartBtn = document.getElementById('restartBtn');

const timerBox = document.getElementById('timerBox');
const timerDisplay = document.getElementById('timer');

const forging = document.getElementById('forging');
const forgeFill = document.getElementById('forgeFill');
const finalOverlay = document.getElementById('finalOverlay');
const finalCloseBtn = document.getElementById('finalClose');
const finalScoreSpan = document.getElementById('finalScore');
const finalStreakSpan = document.getElementById('finalStreak');

/* =========================
   GAME STATE
   ========================= */
let levels = [];
let currentLevelIndex = 0;

let selectedCourseId = null;
let selectedCourseEl = null;

let jobMatchedById = new Set();
let matchesThisLevel = 0;

let attempts = 0;
let score = 0;
let streak = 0;
let longestStreak = 0;

let streakBoostApplied = false;
let gameLocked = false;

/* Timer */
const TOTAL_TIME_SECONDS = 240;
let timeLeft = TOTAL_TIME_SECONDS;
let timerStarted = false;
let timerInterval = null;

/* =========================
   TIMER
   ========================= */
function formatTime(sec){
  const m = Math.floor(sec / 60);
  const s = sec % 60;
  return `${m}:${String(s).padStart(2,'0')}`;
}
function updateTimerUI(){
  timerDisplay.textContent = formatTime(timeLeft);
  timerBox.classList.remove('warning','danger');
  if (timeLeft <= 60 && timeLeft > 20) timerBox.classList.add('warning');
  else if (timeLeft <= 20) timerBox.classList.add('danger');
}
function startTimerIfNeeded(){
  if (timerStarted) return;
  timerStarted = true;
  timerInterval = setInterval(()=> {
    if (timeLeft <= 0){
      timeLeft = 0;
      updateTimerUI();
      clearInterval(timerInterval);
      timerInterval = null;
      handleTimeUp();
      return;
    }
    timeLeft--;
    updateTimerUI();
  },1000);
}
function stopTimer(){
  if (timerInterval){
    clearInterval(timerInterval);
    timerInterval = null;
  }
}
function handleTimeUp(){
  gameLocked = true;
  timeUpBar.style.display = 'flex';
}
function resetTimer(){
  stopTimer();
  timerStarted = false;
  timeLeft = TOTAL_TIME_SECONDS;
  updateTimerUI();
  timerBox.classList.remove('warning','danger');
}

/* =========================
   CONFETTI (lighter)
   ========================= */
const confettiCtx = confettiCanvas.getContext('2d');
function fireConfetti(){
  const reduceMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
  if (reduceMotion) return;

  const ctx = confettiCtx;
  const w = confettiCanvas.width = window.innerWidth;
  const h = confettiCanvas.height = window.innerHeight;
  confettiCanvas.style.display = 'block';

  const pieces = [];
  const count = Math.floor(Math.min(90, w/10));
  for(let i=0;i<count;i++){
    pieces.push({
      x: Math.random()*w,
      y: Math.random()*-h*0.4,
      w: 6 + Math.random()*10,
      h: 6 + Math.random()*10,
      vx: -2 + Math.random()*4,
      vy: 2 + Math.random()*6,
      rot: Math.random()*360,
      speed: 0.02 + Math.random()*0.06,
      color: ['#2563eb','#ef4444','#10b981','#f59e0b','#7c3aed'][Math.floor(Math.random()*5)]
    });
  }

  const start = performance.now();
  function render(t){
    ctx.clearRect(0,0,w,h);
    for(let p of pieces){
      p.x += p.vx;
      p.y += p.vy;
      p.rot += p.speed*30;
      ctx.save();
      ctx.translate(p.x,p.y);
      ctx.rotate(p.rot*Math.PI/180);
      ctx.fillStyle = p.color;
      ctx.fillRect(-p.w/2,-p.h/2,p.w,p.h);
      ctx.restore();
    }
    if ((t - start) < 2000) requestAnimationFrame(render);
    else {
      confettiCanvas.style.display = 'none';
      ctx.clearRect(0,0,w,h);
    }
  }
  requestAnimationFrame(render);
}

window.addEventListener('resize', ()=> {
  if (confettiCanvas.style.display !== 'none'){
    confettiCanvas.width = window.innerWidth;
    confettiCanvas.height = window.innerHeight;
  }
});

/* =========================
   SCORING NOTE
   ========================= */
function updateScoringNote(level){
  scoringNoteEl.innerHTML = `
    Scoring: Correct match <strong>+10</strong>, wrong match <strong>-5</strong> (never below 0).
    Get <strong>${level.streakTarget}</strong> correct in a row to trigger a <strong>${level.multiplier.toFixed(1)}×</strong> boost!
  `;
}

/* =========================
   LEVEL UI
   ========================= */
function clearSelections(){
  if (selectedCourseEl) selectedCourseEl.classList.remove('selected');
  selectedCourseEl = null;
  selectedCourseId = null;
}

function loadLevel(levelIndex){
  const level = levels[levelIndex];
  currentLevelIndex = levelIndex;

  clearSelections();
  jobMatchedById = new Set();
  matchesThisLevel = 0;
  streakBoostApplied = false;

  headerTitleEl.textContent = `Match the Courses to Its Future Job Prospects ${level.titleSuffix}`;
  levelLabelEl.textContent = `Level ${level.id} of ${TOTAL_LEVELS}`;
  updateScoringNote(level);

  matchedCountEl.textContent = '0';
  matchesTotalEl.textContent = String(level.totalMatches);

  coursesList.innerHTML = '';
  level.courses.forEach((course) => {
    const div = document.createElement('div');
    div.className = 'item';
    div.dataset.type = 'course';
    div.dataset.id = course.id;
    div.innerHTML = `
      <div class="course-label">${course.name}</div>
      <div class="pill">Course</div>
    `;
    coursesList.appendChild(div);
  });

  jobsList.innerHTML = '';
  level.jobs.forEach((job) => {
    const div = document.createElement('div');
    div.className = 'item';
    div.dataset.type = 'job';
    div.dataset.id = job.id;
    div.innerHTML = `
      <div class="job-main">
        <div class="job-title">${job.title}</div>
        <div class="job-sub">${job.sub || ''}</div>
      </div>
      <div class="pill">Tap to match</div>
    `;
    jobsList.appendChild(div);
  });
}

/* =========================
   INPUT (delegated)
   ========================= */
coursesList.addEventListener('click', (e) => {
  if (gameLocked) return;
  const item = e.target.closest('.item[data-type="course"]');
  if (!item) return;

  startTimerIfNeeded();

  if (selectedCourseEl) selectedCourseEl.classList.remove('selected');
  selectedCourseEl = item;
  selectedCourseId = item.dataset.id;
  selectedCourseEl.classList.add('selected');
});

jobsList.addEventListener('click', (e) => {
  if (gameLocked) return;
  const item = e.target.closest('.item[data-type="job"]');
  if (!item) return;

  startTimerIfNeeded();

  const jobId = item.dataset.id;
  if (jobMatchedById.has(jobId)) return;

  if (!selectedCourseId){
    item.classList.add('selected');
    setTimeout(()=> item.classList.remove('selected'), 220);
    return;
  }

  attemptMatch(selectedCourseId, jobId, item);
});

/* =========================
   MATCHING
   ========================= */
function attemptMatch(courseId, jobId, jobEl){
  const level = levels[currentLevelIndex];

  attempts++;
  attemptsEl.textContent = attempts;

  const isCorrect = level.matchSet.has(`${courseId}|${jobId}`);
  const courseEl = coursesList.querySelector(`.item[data-id="${courseId}"]`);

  if (isCorrect){
    jobMatchedById.add(jobId);
    matchesThisLevel++;
    matchedCountEl.textContent = String(matchesThisLevel);

    applyScoreChange(+10);

    if (jobEl){
      jobEl.classList.add('matched','correctFlash');
      const pill = jobEl.querySelector('.pill');
      if (pill) pill.textContent = 'Matched';
      setTimeout(()=> jobEl.classList.remove('correctFlash'), 350);
    }
    if (courseEl){
      courseEl.classList.add('correctFlash');
      setTimeout(()=> courseEl.classList.remove('correctFlash'), 350);
    }

    streak++;
    if (streak > longestStreak) longestStreak = streak;
    streakEl.textContent = streak;

    if (streak >= level.streakTarget && !streakBoostApplied){
      streakBoostApplied = true;
      score = Math.round(score * level.multiplier);
      scoreEl.textContent = score;
      scoreEl.classList.add('bump');
      streakBadge.textContent = `Streak bonus! x${level.multiplier.toFixed(1)} applied`;
      showStreakBadge();
      setTimeout(()=> scoreEl.classList.remove('bump'), 260);
    }

    if (matchesThisLevel === level.totalMatches){
      if (currentLevelIndex < levels.length - 1){
        setTimeout(()=> loadLevel(currentLevelIndex + 1), 600);
      } else {
        showForgingThenFinalModal();
      }
    }
  } else {
    streak = 0;
    streakBoostApplied = false;
    streakEl.textContent = streak;

    applyScoreChange(-5);

    if (jobEl){
      jobEl.classList.add('wrongFlash');
      setTimeout(()=> jobEl.classList.remove('wrongFlash'), 320);
    }
    if (courseEl){
      courseEl.classList.add('wrongFlash');
      setTimeout(()=> courseEl.classList.remove('wrongFlash'), 320);
    }
  }

  clearSelections();
}

/* =========================
   SCORING
   ========================= */
function applyScoreChange(delta){
  if (delta > 0) score += delta;
  else score = Math.max(0, score + delta);

  scoreEl.textContent = score;
  scoreEl.classList.add('bump');

  scoreDeltaEl.className = '';
  scoreDeltaEl.textContent = (delta > 0 ? `+${delta}` : `${delta}`);
  scoreDeltaEl.classList.add('show', delta > 0 ? 'positive' : 'negative');

  setTimeout(()=> scoreEl.classList.remove('bump'), 260);
  setTimeout(()=> scoreDeltaEl.classList.remove('show','positive','negative'), 700);
}

/* =========================
   STREAK BADGE
   ========================= */
function showStreakBadge(){
  streakBadge.classList.add('show');
  setTimeout(()=> streakBadge.classList.remove('show'), 2000);
}

/* =========================
   FORGING + FINAL
   ========================= */
function showForgingThenFinalModal(){
  stopTimer();
  timeUpBar.style.display = 'none';
  gameLocked = true;

  forging.style.display = 'flex';
  forging.setAttribute('aria-hidden','false');
  forgeFill.style.width = '0%';

  setTimeout(()=> { forgeFill.style.width = '100%'; }, 50);

  setTimeout(()=> {
    forging.style.display = 'none';
    forging.setAttribute('aria-hidden','true');

    fireConfetti();
    finalScoreSpan.textContent = score;
    finalStreakSpan.textContent = longestStreak;

    finalOverlay.classList.add('show');
    finalOverlay.setAttribute('aria-hidden','false');
  }, 1600);
}

/* =========================
   RESET / RESTART
   ========================= */
function hardResetToLevel1(){
  attempts = 0;
  score = 0;
  streak = 0;
  longestStreak = 0;
  streakBoostApplied = false;
  gameLocked = false;

  attemptsEl.textContent = attempts;
  scoreEl.textContent = score;
  streakEl.textContent = streak;
  matchedCountEl.textContent = '0';

  resetTimer();
  timeUpBar.style.display = 'none';

  finalOverlay.classList.remove('show');
  finalOverlay.setAttribute('aria-hidden','true');
  forging.style.display = 'none';
  forging.setAttribute('aria-hidden','true');
  forgeFill.style.width = '0%';

  levels = generateLevels();   // randomize every restart/new user
  loadLevel(0);
}

resetBtn.addEventListener('click', hardResetToLevel1);
restartBtn.addEventListener('click', hardResetToLevel1);

finalCloseBtn.addEventListener('click', ()=> {
  finalOverlay.classList.remove('show');
  finalOverlay.setAttribute('aria-hidden','true');
});

/* =========================
   INIT
   ========================= */
updateTimerUI();
hardResetToLevel1();
</script>
</body>
</html>
