<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Fill the Blanks — SEG Open House</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg1:#0f172a; --bg2:#1e293b;
  --card-bg: rgba(15,23,42,0.92);
  --accent-500:#2563eb; --accent-400:#3b82f6;
  --muted:#9aa6c0; --success:#10b981; --danger:#ef4444;
  --card-radius:16px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:"Poppins",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
  color:#e6eef8;
  /* FULL-SCREEN BACKGROUND IMAGE */
  background-color:#020617;
  background-image:url("NYP-FA.webp"); /* update path if needed */
  background-size:cover;
  background-position:center;
  background-repeat:no-repeat;
  background-attachment:fixed;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
  padding:20px;
  display:flex;
  justify-content:center;
  align-items:flex-start;
  position:relative;
  overflow-x:hidden;
}
body::before{
  content:"";
  position:fixed;
  inset:0;
  background:
    radial-gradient(circle at top left, rgba(37,99,235,0.35), transparent 55%),
    radial-gradient(circle at bottom right, rgba(8,47,73,0.55), transparent 60%),
    rgba(15,23,42,0.82);
  z-index:-1;
}

/* stage */
.stage{
  width:100%;
  max-width:980px;
}

/* header/hero */
header{
  display:flex;
  gap:16px;
  align-items:flex-start;
  margin-bottom:14px;
  flex-wrap:wrap;
}
.hero{
  flex:1;
  background: rgba(15,23,42,0.9);
  border-radius:12px;
  padding:14px;
  box-shadow: 0 10px 30px rgba(2,6,23,.6);
  display:flex;
  align-items:center;
  gap:12px;
  flex-wrap:wrap;
}
.logo{
  width:56px;height:56px;border-radius:12px;
  display:flex;align-items:center;justify-content:center;
  background:linear-gradient(135deg,var(--accent-500),var(--accent-400));
  color:white;font-weight:700;font-size:20px;
  box-shadow: 0 6px 18px rgba(59,130,246,0.35);
}
.hero h1{margin:0;font-size:1.15rem}
.hero p{margin:4px 0 0;color:var(--muted);font-size:.96rem}

/* card */
.card{
  background:var(--card-bg);
  backdrop-filter:blur(12px);
  border-radius:var(--card-radius);
  padding:16px;
  box-shadow: 0 18px 50px rgba(2,6,23,.8);
  border: 1px solid rgba(148,163,184,0.18);
}

/* HOW TO PLAY (same style family as matching game) */
.card.howto{
  margin-bottom:12px;
  background:rgba(15,23,42,0.96);
  border:1px solid rgba(148,163,184,0.4);
}
.howto-title{
  font-size:.95rem;
  font-weight:600;
  margin:0 0 6px;
}
.howto-list{
  margin:0;
  padding-left:18px;
  font-size:.85rem;
  color:var(--muted);
}
.howto-list li{margin-bottom:4px;}
.howto-highlight{color:#e5edff;font-weight:500;}

/* progress bar */
.progress-wrap{
  margin-bottom:12px;
  display:flex;
  align-items:center;
  gap:12px;
}
#progressContainer{
  flex:1;
  height:12px;
  background: rgba(15,23,42,0.9);
  border-radius:999px;
  overflow:hidden;
  box-shadow: inset 0 2px 6px rgba(0,0,0,0.45);
}
#progressBar{
  height:100%;
  width:0%;
  transition: width .28s ease, box-shadow .28s ease;
  background: linear-gradient(90deg,#22c55e,#4ade80);
}

/* question */
.question{
  margin-bottom:14px;
  padding:10px;
  border-radius:12px;
  background:rgba(15,23,42,0.55);
  word-break:break-word;
}
.question h3{margin:0 0 6px;font-size:0.98rem;color:#e6f0ff}
.hint{margin:0 0 8px;color:var(--muted);font-size:.92rem}
p.desc{
  line-height:1.6;
  color:#e6eef8;
  font-size:.98rem;
  margin:0;
  word-break:break-word;
}

/* input */
input.blank{
  min-width:84px;
  border-radius:6px;
  border:0;
  border-bottom:2px solid rgba(148,163,184,0.55);
  background: rgba(15,23,42,0.85);
  padding:6px 8px;
  margin:0 6px;
  font-weight:600;
  color:#fff;
  outline:none;
  transition: box-shadow .15s, border-color .15s, transform .08s, background .15s;
  display:inline-block;
  font-size:.95rem;
  text-align:left;
}
input.blank:focus{
  border-bottom-color: rgba(59,130,246,0.9);
  background:rgba(15,23,42,0.98);
  box-shadow: 0 8px 18px rgba(59,130,246,0.18);
  transform: translateY(-2px);
}
input.blank.correct{
  border-bottom-color: rgba(16,185,129,0.9) !important;
  box-shadow: 0 10px 22px rgba(16,185,129,0.4);
}
input.blank.wrong{
  border-bottom-color: rgba(239,68,68,0.9) !important;
  box-shadow: 0 8px 20px rgba(239,68,68,0.35);
}

/* controls */
.controls{
  display:flex;
  gap:10px;
  align-items:center;
  margin-top:12px;
  flex-wrap:wrap;
}
.btn{
  background:linear-gradient(180deg,var(--accent-400),var(--accent-500));
  color:white;
  border:none;
  padding:10px 14px;
  border-radius:10px;
  font-weight:700;
  cursor:pointer;
  display:inline-flex;
  align-items:center;
  gap:8px;
  font-size:.95rem;
  box-shadow: 0 10px 26px rgba(37,99,235,0.4);
}
.btn:hover{ transform:translateY(-1px); }
.btn:active{
  transform:translateY(0);
  box-shadow:0 4px 16px rgba(37,99,235,0.3);
}
.btn.ghost{
  background:transparent;
  color:var(--accent-400);
  border:1px solid rgba(59,130,246,0.4);
  box-shadow:none;
  padding:9px 12px;
}
.btn:disabled{
  opacity:0.6;
  cursor:default;
}
.stats{
  margin-left:auto;
  color:var(--muted);
  font-weight:600;
}

/* confetti canvas */
#confetti{
  position:fixed;
  inset:0;
  pointer-events:none;
  z-index:60;
  display:none;
}

/* overlay/modal */
.overlay{
  position:fixed;
  inset:0;
  display:none;
  align-items:center;
  justify-content:center;
  background: linear-gradient(rgba(3,7,18,0.7), rgba(3,7,18,0.7));
  z-index:70;
}
.overlay.show{ display:flex; }
.modal{
  width:100%;
  max-width:460px;
  background:linear-gradient(180deg,#0b1220,#071029);
  border-radius:14px;
  padding:22px;
  text-align:center;
  box-shadow:0 30px 80px rgba(2,6,23,.9);
  border:1px solid rgba(148,163,184,0.35);
  transform:translateY(8px);
  opacity:0;
  transition:transform .28s cubic-bezier(.2,.9,.2,1),opacity .18s;
}
.overlay.show .modal{
  transform:translateY(0);
  opacity:1;
}
.modal h3{ margin:0; font-size:1.18rem; color:#ffd166; }
.modal p{ color:var(--muted); margin-top:8px; }
.modal .key{
  width:96px;height:96px;margin:16px auto 8px;
  border-radius:16px;
  display:flex;align-items:center;justify-content:center;
  background:linear-gradient(135deg,#ffd166,#f4a261);
  box-shadow:0 12px 28px rgba(244,162,97,0.28);
}

/* forging overlay (small) */
#forging{
  position:fixed;
  inset:0;
  display:none;
  align-items:center;
  justify-content:center;
  z-index:75;
  pointer-events:none;
}
#forging .box{
  width:320px;
  max-width:92%;
  background:linear-gradient(180deg,#071029,#081424);
  color:white;
  padding:18px;
  border-radius:12px;
  text-align:center;
  box-shadow:0 14px 40px rgba(2,6,23,.9);
  border:1px solid rgba(148,163,184,0.35);
}
.forge-bar{
  height:10px;
  background: rgba(15,23,42,0.9);
  border-radius:999px;
  overflow:hidden;
  margin-top:12px;
}
.forge-fill{
  height:100%;
  width:0%;
  background: linear-gradient(90deg,#ffd166,#f4a261);
  transition: width 1.2s ease;
}

/* mascot */
#mascot{
  position:fixed;
  left:14px;
  bottom:14px;
  background: rgba(15,23,42,0.92);
  padding:10px 12px;
  border-radius:14px;
  display:flex;
  gap:10px;
  align-items:center;
  z-index:80;
  color:#eaf2ff;
  box-shadow:0 8px 26px rgba(2,6,23,0.8);
  transform:translateY(18px);
  opacity:0;
  transition: all .3s ease;
  max-width:260px;
}
#mascot.show{
  transform:translateY(0);
  opacity:1;
}
#mascot img{
  width:40px;
  height:40px;
  border-radius:50%;
}

/* small util */
.small{ font-size:.95rem; color:var(--muted); }

/* Timer box */
#timerBox{
  background: rgba(15,23,42,0.9);
  padding: 8px 14px;
  border-radius: 12px;
  font-size: 0.95rem;
  font-weight: 600;
  display: flex;
  flex-direction:column;
  align-items:flex-start;
  gap: 4px;
  color: #e5edff;
  box-shadow: 0 8px 24px rgba(0,0,0,0.55);
  white-space:nowrap;
}
#timer{
  font-size: 1.2rem;
  color: var(--accent-400);
}
#timer.warning{ color:#facc15; }
#timer.danger{ color:#fb7185; }

@keyframes pulse {
  0% { box-shadow: 0 0 0 rgba(59,130,246,0.0); }
  50% { box-shadow: 0 0 18px rgba(59,130,246,0.9); }
  100% { box-shadow: 0 0 0 rgba(59,130,246,0.0); }
}
.progress-bar-warning{
  animation: pulse 1s infinite;
}

/* MOBILE */
@media (max-width:780px){
  body{
    padding:14px;
    align-items:flex-start;
  }
  header{
    flex-direction:column;
    align-items:flex-start;
  }
  .hero{
    flex-direction:row;
    align-items:flex-start;
  }
  .controls{
    flex-direction:column;
    align-items:stretch;
  }
  .stats{
    margin-left:0;
    margin-top:6px;
  }
  input.blank{
    min-width:100%;
    margin:6px 0;
    font-size:1rem;
    display:block;
  }
  #mascot{
    left:10px;
    bottom:10px;
    max-width:220px;
    font-size:.85rem;
  }
}
@media (max-width:480px){
  .hero h1{font-size:1rem;}
  .hero p{font-size:.85rem;}
}
</style>
</head>
<body>
<div class="stage">
  <header>
    <div class="hero" aria-hidden="false">
      <div class="logo">SEG</div>
      <div>
        <h1>Fill In The Missing Words</h1>
        <p class="lead small" style="margin:4px 0 0;color:var(--muted)">
          Read the full descriptions on the wall. Fill in all blanks within <strong>3 minutes</strong> to collect <strong>Key #2</strong>.
        </p>
      </div>
    </div>
    <div id="timerBox">
      <span id="timerLabel">Time Left</span>
      <!-- MM:SS format -->
      <span id="timer">3:00</span>
    </div>
  </header>

  <main>
    <!-- NEW HOW TO PLAY CARD -->
    <section class="card howto" aria-label="How to play">
      <h2 class="howto-title">How to Play</h2>
      <ol class="howto-list">
        <li>Look at the <span class="howto-highlight">course title and description</span> for each question.</li>
        <li>Refer to the <span class="howto-highlight">printed information on the wall</span> for clues.</li>
        <li>Type the <span class="howto-highlight">missing keyword</span> into each blank box.</li>
        <li>Tap <span class="howto-highlight">Submit Answers</span> to check your answers — correct blanks turn green, wrong ones turn red.</li>
        <li>Fill in <span class="howto-highlight">all blanks correctly</span> before the timer reaches <strong>0:00</strong> to earn <strong>Key #2</strong>.</li>
      </ol>
    </section>

    <section class="card" aria-labelledby="gameTitle">
      <!-- Progress -->
      <div class="progress-wrap">
        <div id="progressContainer" aria-hidden="true"><div id="progressBar"></div></div>
        <div class="small" id="progressText">0 / 0</div>
      </div>

      <div id="questionsContainer" role="list" aria-live="polite"></div>

      <div class="controls" style="margin-top:12px;">
        <button id="submitBtn" class="btn" aria-label="Submit answers">Submit Answers</button>
        <button id="resetBtn" class="btn ghost" aria-label="Reset">Reset</button>
        <div class="stats small" aria-live="polite">Attempts: <span id="attempts">0</span></div>
      </div>

      <p class="note small">Tip: Answers are case-insensitive. Each blank replaces the first occurrence of the word in the description.</p>
    </section>
  </main>
</div>

<!-- confetti canvas -->
<canvas id="confetti"></canvas>

<!-- forging animation -->
<div id="forging" aria-hidden="true">
  <div class="box">
    <div style="font-weight:700;color:#ffd166;">Forging Key #2...</div>
    <div class="small" style="margin-top:6px;color:var(--muted);">Hang on — almost done</div>
    <div class="forge-bar"><div class="forge-fill" id="forgeFill"></div></div>
  </div>
</div>

<!-- mascot -->
<div id="mascot" aria-hidden="true">
  <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><circle cx='32' cy='24' r='14' fill='%232563eb'/><rect x='12' y='38' width='40' height='18' rx='6' fill='%231e293b'/></svg>" alt="mascot"/>
  <div id="mascotText" class="small">Welcome! Fill the blanks to earn Key #2.</div>
</div>

<!-- Key modal (final) -->
<div id="overlay" class="overlay" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal" role="document" aria-labelledby="modalTitle">
    <div class="key" aria-hidden="true">
      <svg width="56" height="56" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <linearGradient id="k" x1="0" x2="1">
            <stop offset="0" stop-color="#ffd166"/><stop offset="1" stop-color="#f4a261"/>
          </linearGradient>
        </defs>
        <path d="M44 24a12 12 0 1 0-8.485 11.314L43 31.828V36h4v6h-4v4h-4v-4h-4v4h-6l-9 9v-6H8v-8h8v-6h6v-6l2-2.001A12 12 0 0 0 44 24z" fill="url(#k)"/>
      </svg>
    </div>
    <h3 id="modalTitle">Key #2 Received!</h3>
    <p class="small">Great! Screenshot this page to claim your prize at Level 1.</p>
    <div style="margin-top:14px;display:flex;gap:10px;justify-content:center;">
      <button id="closeModal" class="btn ghost" aria-label="Close">Close</button>
    </div>
  </div>
</div>

<script>
/* =========================
   Questions
   ========================= */
const questions = [
  {
    title: "Advanced & Digital Manufacturing — 3D printing",
    fullText: "Turn ideas into impact with advanced 3D printing – from building parts for planes to creating custom-fit implants that save lives in healthcare.",
    blanks: ["impact", "building"]
  },
  {
    title: "Aerospace Engineering — Aircraft & Space",
    fullText: "Shape the future of flying. Enter the exciting world of aerospace, boost your career with top-notch skills, and make your mark in the skies.",
    blanks: ["future", "aerospace"]
  },
  {
    title: "Cloud Engineering — Network Distributed Systems",
    fullText: "Become engineers who design and build infrastructures behind the next Netflix or Spotify. Create digital solutions sought after by tech giants like Google, IBM, and Oracle.",
    blanks: ["infrastructures", "digital"]
  },
  {
    title: "Biomedical Engineering — Health Technology",
    fullText: "Build a strong foundation in biology and engineering, design life-saving medical devices, and create smart healthcare solutions. ",
    blanks: ["biology", "life", "healthcare"]
  },
  {
    title: "AI & Data Engineering — Intelligent Systems",
    fullText: "Learn to harness the power of AI and data in creating smart engineering solutions to transform electronics, robotics, manufacturing, and infocomm industries.",
    blanks: ["smart", "solutions", "robotics"]
  }
];

/* =========================
   DOM refs & state
   ========================= */
const container = document.getElementById('questionsContainer');
const submitBtn = document.getElementById('submitBtn');
const resetBtn = document.getElementById('resetBtn');
const attemptsEl = document.getElementById('attempts');
const overlay = document.getElementById('overlay');
const closeModal = document.getElementById('closeModal');
const confettiCanvas = document.getElementById('confetti');
const progressBar = document.getElementById('progressBar');
const progressText = document.getElementById('progressText');
const forging = document.getElementById('forging');
const forgeFill = document.getElementById('forgeFill');
const mascot = document.getElementById('mascot');
const mascotText = document.getElementById('mascotText');
const timerDisplay = document.getElementById("timer");

let attempts = 0;
let totalBlanks = 0;

/* -------------------------
   Audio (WebAudio short tones)
   ------------------------- */
const AudioCtx = window.AudioContext || window.webkitAudioContext;
let audioCtx = null;
function playTone(freq, time=0.06, type='sine', gain=0.06) {
  try {
    if (!audioCtx) audioCtx = new AudioCtx();
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = type;
    o.frequency.value = freq;
    g.gain.value = gain;
    o.connect(g); g.connect(audioCtx.destination);
    o.start();
    g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + time);
    setTimeout(()=> o.stop(), time*1000 + 20);
  } catch(e){}
}
function playClick(){ playTone(880, 0.045, 'sine', 0.02); }
function playCorrect(){ playTone(1100, 0.11, 'triangle', 0.06); }
function playWrong(){ playTone(200, 0.08, 'sine', 0.03); }
function playSuccess(){
  playTone(720, 0.22, 'sine', 0.08);
  setTimeout(()=> playTone(980,0.16,'sine',0.06), 120);
}

/* =========================
   Helpers
   ========================= */
function escapeRegExp(string) {
  return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}

/* format seconds as MM:SS */
function formatTime(seconds){
  const m = Math.floor(seconds / 60);
  const s = seconds % 60;
  return `${m}:${s.toString().padStart(2,'0')}`;
}

function updateProgress() {
  const inputs = Array.from(container.querySelectorAll('input.blank'));
  const correctCount = inputs.reduce((acc, inp) => {
    const qIdx = Number(inp.dataset.q);
    const bIdx = Number(inp.dataset.b);
    if (!isNaN(qIdx) && !isNaN(bIdx)) {
      const expected = questions[qIdx].blanks[bIdx];
      if ((inp.value || '').trim().toLowerCase() === expected.toLowerCase()) return acc + 1;
    }
    return acc;
  }, 0);
  const pct = totalBlanks === 0 ? 0 : Math.round((correctCount/totalBlanks)*100);
  progressBar.style.width = pct + '%';
  progressText.textContent = `${correctCount} / ${totalBlanks}`;
  if (pct === 100){
    progressBar.style.boxShadow = '0 6px 20px rgba(34,197,94,0.6), 0 0 18px rgba(34,197,94,0.5)';
  } else {
    progressBar.style.boxShadow = '';
  }
  if (pct === 0) showMascotOnce("Start filling the blanks — you're off to a good start!");
  else if (pct > 0 && pct < 40) showMascotOnce("Nice! Keep going — you're making progress.");
  else if (pct >= 40 && pct < 80) showMascotOnce("Great job — you're almost halfway!");
  else if (pct >= 80 && pct < 100) showMascotOnce("So close! Just a few more.");
}

/* mascot helper */
let mascotTimer = null;
function showMascotOnce(text, duration=2200) {
  clearTimeout(mascotTimer);
  mascotText.textContent = text;
  mascot.classList.add('show');
  mascot.setAttribute('aria-hidden','false');
  mascotTimer = setTimeout(()=> {
    mascot.classList.remove('show');
    mascot.setAttribute('aria-hidden','true');
  }, duration);
}

/* =========================
   Build questions UI
   ========================= */
function buildQuestions(){
  container.innerHTML = '';
  totalBlanks = 0;
  questions.forEach((q, qi) => {
    const node = document.createElement('article');
    node.className = 'question';
    node.id = `q${qi}`;
    node.setAttribute('role','listitem');

    const header = document.createElement('h3');
    header.textContent = `Question ${qi+1}: ${q.title}`;
    node.appendChild(header);

    const hint = document.createElement('div');
    hint.className = 'hint';
    hint.textContent = 'Refer to the printed description on the wall to complete the blanks.';
    node.appendChild(hint);

    let html = q.fullText;
    q.blanks.forEach((blank, bi) => {
      const token = `@@BLANK_${qi}_${bi}@@`;
      const reWord = new RegExp('\\b' + escapeRegExp(blank) + '\\b', 'i');
      if (reWord.test(html)) html = html.replace(reWord, token);
      else html = html.replace(new RegExp(escapeRegExp(blank), 'i'), token);
      totalBlanks++;
    });

    const parts = html.split(/(@@BLANK_\d+_\d+@@)/g);
    const p = document.createElement('p');
    p.className = 'desc';
    parts.forEach(part => {
      if (!part) return;
      const m = part.match(/^@@BLANK_(\d+)_(\d+)@@$/);
      if (m) {
        const qIdxStr = m[1], bIdxStr = m[2];
        const input = document.createElement('input');
        input.className = 'blank';
        input.type = 'text';
        input.id = `input_${qIdxStr}_${bIdxStr}`;
        input.autocapitalize = 'off';
        input.spellcheck = false;
        input.dataset.q = qIdxStr;
        input.dataset.b = bIdxStr;
        input.setAttribute('aria-label', `Blank ${Number(qIdxStr)+1}-${Number(bIdxStr)+1}`);
        input.addEventListener('input', (e) => {
          playClick();
          const expected = questions[Number(qIdxStr)].blanks[Number(bIdxStr)];
          const val = (e.target.value || '').trim();
          e.target.classList.remove('correct','wrong');
          if (val.length === 0) { /* nothing */ }
          else if (val.toLowerCase() === expected.toLowerCase()) {
            e.target.classList.add('correct');
            playCorrect();
          } else {
            e.target.classList.add('wrong');
            playWrong();
          }
          updateProgress();
        });
        input.addEventListener('keydown', (ev) => {
          if (ev.key === 'Enter') {
            ev.preventDefault();
            const all = Array.from(container.querySelectorAll('input.blank'));
            const idx = all.indexOf(ev.target);
            if (idx >= 0 && idx < all.length - 1) all[idx+1].focus();
          }
        });
        p.appendChild(input);
      } else {
        p.appendChild(document.createTextNode(part));
      }
    });

    node.appendChild(p);
    container.appendChild(node);
  });

  attemptsEl.textContent = attempts;
  progressText.textContent = `0 / ${totalBlanks}`;
  progressBar.style.width = '0%';
  setTimeout(()=> {
    const first = container.querySelector('input.blank');
    if (first) first.focus();
  }, 160);
}

/* =========================
   Validation & Submit
   ========================= */
function validateAnswers(){
  const inputs = Array.from(container.querySelectorAll('input.blank'));
  let allCorrect = true;
  inputs.forEach(inp => {
    inp.classList.remove('correct','wrong');
    const qIdx = Number(inp.dataset.q);
    const bIdx = Number(inp.dataset.b);
    const expected = questions[qIdx].blanks[bIdx];
    const value = (inp.value || '').trim();
    if (!value) {
      allCorrect = false;
      inp.classList.add('wrong');
    } else if (value.toLowerCase() === expected.toLowerCase()) {
      inp.classList.add('correct');
    } else {
      allCorrect = false;
      inp.classList.add('wrong');
    }
  });
  updateProgress();
  return allCorrect;
}

/* small shake animation */
function shake(el) {
  el.animate(
    [{transform:'translateX(-6px)'},{transform:'translateX(6px)'},{transform:'translateX(0)'}],
    {duration:240,iterations:1}
  );
}

/* =========================
   Confetti
   ========================= */
const confettiCtx = confettiCanvas.getContext('2d');
function fireConfetti(){
  const ctx = confettiCtx;
  const w = confettiCanvas.width = window.innerWidth;
  const h = confettiCanvas.height = window.innerHeight;
  confettiCanvas.style.display = 'block';
  const pieces = [];
  const count = Math.floor(Math.min(120, w/6));
  for(let i=0;i<count;i++){
    pieces.push({
      x: Math.random()*w,
      y: Math.random()*-h*0.4,
      w: 6 + Math.random()*10,
      h: 6 + Math.random()*10,
      vx: -2 + Math.random()*4,
      vy: 2 + Math.random()*6,
      rot: Math.random()*360,
      speed: 0.02 + Math.random()*0.06,
      color: ['#2563eb','#ef4444','#10b981','#f59e0b','#7c3aed'][Math.floor(Math.random()*5)]
    });
  }
  let t0 = performance.now();
  const startTime = performance.now();
  function render(t){
    const dt = t - t0; t0 = t;
    ctx.clearRect(0,0,w,h);
    for(let p of pieces){
      p.x += p.vx; p.y += p.vy; p.rot += p.speed*30;
      ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.rot*Math.PI/180);
      ctx.fillStyle = p.color; ctx.fillRect(-p.w/2,-p.h/2,p.w,p.h); ctx.restore();
    }
    if ((t - startTime) < 2600) requestAnimationFrame(render);
    else { confettiCanvas.style.display = 'none'; ctx.clearRect(0,0,w,h); }
  }
  requestAnimationFrame(render);
}

/* =========================
   Key forging animation + modal
   ========================= */
function showForgingThenModal() {
  forgeFill.style.width = '0%';
  forging.style.display = 'flex';
  forging.setAttribute('aria-hidden','false');
  setTimeout(()=> forgeFill.style.width = '100%', 60);
  setTimeout(()=> {
    forging.style.display = 'none';
    forging.setAttribute('aria-hidden','true');
    playSuccess();
    fireConfetti();
    overlay.classList.add('show');
    overlay.setAttribute('aria-hidden','false');
  }, 1400);
}

/* =========================
   TIMER SYSTEM (3 MINUTES, MM:SS)
   ========================= */
let timeLeft = 180;       // 3 minutes
let timerInterval = null;
let timerStarted = false;

function startTimer() {
  if (timerStarted) return;
  timerStarted = true;
  timerInterval = setInterval(() => {
    timeLeft--;
    if (timeLeft < 0) timeLeft = 0;
    timerDisplay.textContent = formatTime(timeLeft);

    if (timeLeft <= 30 && timeLeft > 10) {
      timerDisplay.classList.add("warning");
      timerDisplay.classList.remove("danger");
    }
    if (timeLeft <= 10) {
      timerDisplay.classList.add("danger");
      timerDisplay.classList.remove("warning");
      timerDisplay.style.transform = "scale(1.15)";
      setTimeout(() => (timerDisplay.style.transform = "scale(1)"), 150);
    }

    if (timeLeft <= 0) {
      clearInterval(timerInterval);
      timerStarted = false;
      disableAllInputs();
      showBottomMessage("Time's up! Try again.", "#fca5a5");
    }
  }, 1000);
}

function stopTimer() {
  clearInterval(timerInterval);
  timerInterval = null;
  timerStarted = false;
}

function resetTimer() {
  stopTimer();
  timeLeft = 180;
  timerDisplay.textContent = formatTime(timeLeft);
  timerDisplay.classList.remove("warning","danger");
}

/* disable inputs on time up */
function disableAllInputs() {
  document.querySelectorAll("input.blank").forEach(inp => {
    inp.disabled = true;
    inp.style.opacity = "0.5";
  });
  submitBtn.disabled = true;
}

/* bottom message uses mascot bubble */
function showBottomMessage(msg, color="#fff") {
  mascotText.style.color = color;
  showMascotOnce(msg, 2500);
}

/* start timer when user starts typing */
document.addEventListener("input", e => {
  if (e.target.matches("input.blank")) startTimer();
});

/* =========================
   Event bindings (submit / reset / modal)
   ========================= */
submitBtn.addEventListener('click', ()=>{
  attempts++;
  attemptsEl.textContent = attempts;
  const inputs = Array.from(container.querySelectorAll('input.blank'));
  if (inputs.length === 0) return;

  const anyEmpty = inputs.some(i => !i.value.trim());
  if (anyEmpty) {
    inputs.filter(i=>!i.value.trim()).forEach(i=>i.classList.add('wrong'));
    playWrong();
    shake(container);
    updateProgress();
    return;
  }

  const ok = validateAnswers();
  if (ok) {
    stopTimer();
    showForgingThenModal();
  } else {
    playWrong();
    shake(container);
    showMascotOnce("A few are incorrect — double-check and try again!", 2000);
  }
});

resetBtn.addEventListener('click', ()=>{
  attempts = 0;
  attemptsEl.textContent = attempts;
  resetTimer();
  submitBtn.disabled = false;
  buildQuestions();
  updateProgress();
});

closeModal.addEventListener('click', ()=>{
  overlay.classList.remove('show');
  overlay.setAttribute('aria-hidden','true');
});

window.addEventListener('resize', ()=> {
  if (confettiCanvas.style.display !== 'none') {
    confettiCanvas.width = window.innerWidth;
    confettiCanvas.height = window.innerHeight;
  }
});

/* init */
buildQuestions();
updateProgress();
timerDisplay.textContent = formatTime(timeLeft);
</script>
</body>
</html>
