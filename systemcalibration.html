<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>System Calibration â€” SEG Open House</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
  :root{
    --bg1:#0f172a; --bg2:#1e293b;
    --card-bg: rgba(255,255,255,0.04);
    --accent-500:#2563eb;
    --accent-400:#3b82f6;
    --muted:#9aa6c0;
    --success:#10b981;
    --danger:#ef4444;
    --warn:#facc15;
    --card-radius:16px;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family:"Poppins",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    color:#e6eef8;
    background: linear-gradient(135deg,var(--bg1),var(--bg2));
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    padding:20px;
    display:flex;
    justify-content:center;
  }

  .stage{width:100%;max-width:980px;}

  /* Header with hero + timer */
  header{
    display:flex;
    gap:16px;
    align-items:stretch;
    margin-bottom:18px;
    flex-wrap:wrap;
    justify-content:space-between;
  }

  .hero{
    flex:1;
    background: linear-gradient(90deg, rgba(59,130,246,0.06), rgba(37,99,235,0.03));
    border-radius:12px;
    padding:16px;
    box-shadow: 0 6px 20px rgba(2,6,23,.06);
    display:flex;
    align-items:center;
    gap:14px;
    min-width:0;
  }

  .logo{
    width:56px;height:56px;border-radius:12px;
    display:flex;align-items:center;justify-content:center;
    background:linear-gradient(135deg,var(--accent-500),var(--accent-400));
    color:white;font-weight:700;font-size:20px;
    box-shadow: 0 6px 18px rgba(59,130,246,0.18);
    flex:0 0 56px;
  }

  .hero-text h1{margin:0;font-size:1.05rem}
  .hero-text p{margin:4px 0 0;color:var(--muted);font-size:.9rem}

  /* Timer box top-right */
  #timerBox{
    background: rgba(15,23,42,0.85);
    border-radius:12px;
    padding:10px 14px;
    display:flex;
    flex-direction:column;
    justify-content:center;
    align-items:flex-start;
    min-width:130px;
    box-shadow:0 8px 26px rgba(2,6,23,0.6);
    border:1px solid rgba(148,163,184,0.2);
  }
  #timerLabel{font-size:.8rem;color:var(--muted);}
  #timer{
    font-size:1.3rem;
    font-weight:700;
    color:#22c55e;
  }
  #timerBox.warning #timer{color:var(--warn);}
  #timerBox.danger #timer{color:#fb7185;}

  main{margin-top:4px;display:block;}

  .card{
    background:var(--card-bg);
    border-radius:var(--card-radius);
    padding:16px;
    box-shadow: 0 14px 44px rgba(2,6,23,.28);
    border:1px solid rgba(255,255,255,0.03);
  }

  .top-bar{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
    flex-wrap:wrap;
    margin-bottom:10px;
  }
  .pill{
    font-size:.78rem;
    padding:6px 12px;
    border-radius:999px;
    background:rgba(15,23,42,0.85);
    border:1px solid rgba(148,163,184,0.55);
    color:#cbd5f5;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    min-width:110px;
    white-space:nowrap;
    text-align:center;
  }

  #streakBadge{
    font-size:.85rem;
    padding:6px 10px;
    border-radius:999px;
    background:rgba(34,197,94,0.12);
    color:#bbf7d0;
    border:1px solid rgba(34,197,94,0.3);
    opacity:0;
    transform:translateY(6px);
    transition:opacity .2s ease, transform .2s ease;
  }
  #streakBadge.show{
    opacity:1;
    transform:translateY(0);
  }

  .round-title{
    margin:6px 0 0;
    font-size:1.02rem;
    color:#e6f0ff;
    font-weight:700;
  }
  .round-desc{
    margin:6px 0 0;
    color:var(--muted);
    font-size:.9rem;
    line-height:1.5;
  }

  /* Tracks */
  #tracksArea{margin-top:14px;}

  .trackWrap{
    margin:12px 0;
    padding:12px;
    border-radius:12px;
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border:1px solid rgba(255,255,255,0.04);
  }

  .trackLabel{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:12px;
    font-size:.92rem;
    margin-bottom:10px;
  }
  .lockState{
    color:var(--muted);
    font-size:.85rem;
  }

  .track{
    position:relative;
    height:18px;
    border-radius:999px;
    background: rgba(148,163,184,0.12);
    overflow:hidden;
    box-shadow: inset 0 2px 8px rgba(0,0,0,0.25);
  }

  .zone{
    position:absolute;
    top:0; height:100%;
    left:41%;
    width:18%;
    border-radius:999px;
    background: linear-gradient(90deg, rgba(16,185,129,0.35), rgba(16,185,129,0.18));
    border:1px solid rgba(16,185,129,0.45);
    box-shadow:0 0 18px rgba(16,185,129,0.22);
  }

  /* Round 3 smaller zone (still visible even though logic uses it too) */
  .round3 .zone{
    left:44%;
    width:12%;
  }

  .needle{
    position:absolute;
    top:50%;
    width:12px;
    height:28px;
    transform:translate(-50%,-50%);
    border-radius:10px;
    background: linear-gradient(180deg,#e2e8f0,#94a3b8);
    box-shadow:0 10px 26px rgba(2,6,23,0.55);
  }

  .trackWrap.locked .track{
    background: rgba(16,185,129,0.12);
    border:1px solid rgba(16,185,129,0.25);
  }
  .trackWrap.locked .needle{
    background: linear-gradient(180deg,#10b981,#065f46);
  }
  .trackWrap.overheated .track{
    background: rgba(239,68,68,0.10);
    border:1px solid rgba(239,68,68,0.22);
  }

  /* Controls */
  .controls{
    display:flex;
    gap:10px;
    align-items:center;
    margin-top:14px;
    flex-wrap:wrap;
  }
  .btn{
    background:linear-gradient(180deg,var(--accent-400),var(--accent-500));
    color:white;
    padding:10px 14px;
    border-radius:10px;
    border:0;
    cursor:pointer;
    font-weight:700;
    box-shadow:0 8px 22px rgba(37,99,235,0.18);
    font-size:.92rem;
  }
  .btn.ghost{
    background:transparent;
    color:var(--accent-400);
    border:1px solid rgba(59,130,246,0.3);
    box-shadow:none;
  }
  .btn:disabled{
    opacity:.5;
    cursor:not-allowed;
  }

  .stats{
    margin-left:auto;
    color:var(--muted);
    font-size:.85rem;
    display:flex;
    flex-direction:column;
    align-items:flex-end;
    gap:2px;
  }
  .stats-line{white-space:nowrap;}

  #scoreValue.bump{ animation:scoreBump .25s ease-out; }
  @keyframes scoreBump{
    0%{transform:scale(1);}
    50%{transform:scale(1.2);}
    100%{transform:scale(1);}
  }
  #scoreDelta{
    font-size:.8rem;
    margin-left:6px;
    opacity:0;
    transform:translateY(-4px);
    transition:opacity .2s ease, transform .2s ease;
  }
  #scoreDelta.show{opacity:1; transform:translateY(0);}
  #scoreDelta.positive{color:#4ade80;}
  #scoreDelta.negative{color:#fb7185;}

  .note{
    color:var(--muted);
    font-size:.85rem;
    margin-top:12px;
    line-height:1.5;
  }

  /* Feedback animations */
  .flashGood{ animation:flashGood .35s ease-out; }
  .flashBad{ animation:flashBad .3s ease-out; }

  @keyframes flashGood{
    0%{transform:scale(1); box-shadow:0 0 0 rgba(16,185,129,0);}
    50%{transform:scale(1.01); box-shadow:0 0 18px rgba(16,185,129,0.55);}
    100%{transform:scale(1);}
  }
  @keyframes flashBad{
    0%{transform:translateX(0);}
    25%{transform:translateX(-4px);}
    50%{transform:translateX(4px);}
    75%{transform:translateX(-2px);}
    100%{transform:translateX(0);}
  }

  /* Toast */
  #toast{
    position:fixed;
    left:50%;
    transform:translateX(-50%);
    bottom:18px;
    background: rgba(15,23,42,0.92);
    border:1px solid rgba(148,163,184,0.25);
    color:#e6eef8;
    padding:10px 14px;
    border-radius:999px;
    box-shadow:0 12px 34px rgba(2,6,23,0.65);
    z-index:90;
    opacity:0;
    pointer-events:none;
    transition:opacity .18s ease, transform .18s ease;
    max-width:92%;
    text-align:center;
    font-size:.9rem;
  }
  #toast.show{opacity:1; transform:translateX(-50%) translateY(-4px);}

  /* Confetti */
  #confetti{ position:fixed; inset:0; pointer-events:none; z-index:60; display:none; }

  /* Time up bar */
  #timeUpBar{
    position:fixed;
    left:50%;
    transform:translateX(-50%);
    bottom:16px;
    background:linear-gradient(90deg,#b91c1c,#ef4444);
    color:white;
    padding:10px 16px;
    border-radius:999px;
    display:none;
    align-items:center;
    gap:10px;
    box-shadow:0 10px 30px rgba(127,29,29,0.6);
    z-index:95;
    font-size:.9rem;
  }
  #timeUpBar button{
    background:white;
    color:#b91c1c;
    border:none;
    border-radius:999px;
    padding:6px 12px;
    font-weight:700;
    cursor:pointer;
  }

  /* Forging overlay */
  #forging{
    position:fixed; inset:0;
    display:none;
    align-items:center;
    justify-content:center;
    z-index:110;
    background:linear-gradient(rgba(3,7,18,0.55), rgba(3,7,18,0.55));
  }
  #forging .box{
    width:360px; max-width:92%;
    background:linear-gradient(180deg,#071029,#081424);
    color:white;
    padding:18px;
    border-radius:12px;
    text-align:center;
    box-shadow:0 14px 40px rgba(2,6,23,.6);
    border:1px solid rgba(255,255,255,0.03);
  }
  .forge-bar{
    height:10px;
    background: rgba(255,255,255,0.06);
    border-radius:999px;
    overflow:hidden;
    margin-top:12px;
  }
  .forge-fill{
    height:100%;
    width:0%;
    background: linear-gradient(90deg,#ffd166,#f4a261);
    transition: width 1.2s ease;
  }

  /* Final modal */
  #overlay{
    position:fixed; inset:0;
    display:none;
    align-items:center;
    justify-content:center;
    background:linear-gradient(rgba(3,7,18,0.55), rgba(3,7,18,0.55));
    z-index:120;
  }
  #overlay.show{display:flex;}
  .modal{
    width:100%; max-width:460px;
    background:linear-gradient(180deg,#0b1220,#071029);
    border-radius:14px;
    padding:22px;
    text-align:center;
    box-shadow:0 30px 80px rgba(2,6,23,.6);
    border:1px solid rgba(255,255,255,0.03);
    transform:translateY(8px);
    opacity:0;
    transition:transform .28s cubic-bezier(.2,.9,.2,1),opacity .18s;
  }
  #overlay.show .modal{transform:translateY(0); opacity:1;}
  .modal h3{margin:0;font-size:1.18rem;color:#ffd166;}
  .modal p{color:var(--muted);margin-top:8px;}
  .modal .key{
    width:96px;height:96px;margin:16px auto 8px;border-radius:16px;
    display:flex;align-items:center;justify-content:center;
    background:linear-gradient(135deg,#ffd166,#f4a261);
    box-shadow:0 12px 28px rgba(244,162,97,0.12);
  }
  .modal .scoreline{
    margin-top:10px;
    display:flex;
    justify-content:center;
    gap:10px;
    flex-wrap:wrap;
    color:#e6eef8;
    font-weight:700;
  }
  .modal .scoreline span{
    background:rgba(15,23,42,0.65);
    border:1px solid rgba(148,163,184,0.22);
    padding:6px 10px;
    border-radius:999px;
    font-size:.92rem;
  }

  @media (max-width:780px){
    header{flex-direction:column;}
    #timerBox{align-self:flex-start;}
  }
  @media (max-width:640px){
    body{padding:14px;}
    .logo{width:48px;height:48px;}
    .hero-text h1{font-size:1rem;}
    .hero-text p{font-size:.85rem;}
    .stats{align-items:flex-start;margin-left:0;}
  }
</style>
</head>
<body>
<div class="stage">
  <header>
    <div class="hero">
      <div class="logo">SEG</div>
      <div class="hero-text">
        <h1 id="headerTitle">System Calibration Challenge</h1>
        <p>Skill-based â€” tap <strong>LOCK</strong> when the needle is inside the green zone. Clear all rounds to collect <strong>Key #3</strong>.</p>
      </div>
    </div>
    <div id="timerBox">
      <span id="timerLabel">Time Left</span>
      <span id="timer">4:00</span>
    </div>
  </header>

  <main>
    <section class="card">
      <div class="top-bar">
        <div class="pill" id="roundPill">Round 1 / 3</div>
        <div id="streakBadge">Streak bonus applied!</div>
      </div>

      <div class="round-title" id="roundTitle">Round 1 â€” Warmup Locks</div>
      <div class="round-desc" id="roundDesc">
        Lock each system by tapping <strong>LOCK</strong> when the needle is inside the green zone.
      </div>

      <div id="tracksArea" aria-live="polite"></div>

      <div class="controls">
        <button id="actionBtn" class="btn" aria-label="Lock">LOCK</button>
        <button id="resetBtn" class="btn ghost" aria-label="Reset game">Reset</button>

        <div class="stats" aria-live="polite">
          <div class="stats-line">
            <strong>Score:</strong>
            <span id="scoreValue">0</span>
            <span id="scoreDelta"></span>
          </div>
          <div class="stats-line">
            Streak: <span id="streakValue">0</span> &nbsp;â€¢&nbsp;
            Locked: <span id="doneCount">0</span>/<span id="totalCount">0</span>
          </div>
          <div class="stats-line">
            Attempts: <span id="attempts">0</span>
          </div>
        </div>
      </div>

      <p class="note" id="scoringNote">
        Scoring: Successful lock <strong>+10</strong>, unsuccessful lock <strong>-5</strong> (never below 0).
        Get <strong>4</strong> successful locks in a row to trigger a <strong>1.5Ã—</strong> score boost!
      </p>
    </section>
  </main>
</div>

<canvas id="confetti"></canvas>

<div id="toast"></div>

<div id="timeUpBar">
  <span>Time's up! Restart to try again.</span>
  <button id="restartBtn">Restart</button>
</div>

<!-- Forging overlay -->
<div id="forging" aria-hidden="true">
  <div class="box">
    <div style="font-weight:800;color:#ffd166;">Forging Key #3â€¦</div>
    <div style="margin-top:6px;color:var(--muted);font-size:.92rem;">Please wait</div>
    <div class="forge-bar"><div class="forge-fill" id="forgeFill"></div></div>
  </div>
</div>

<!-- Final popup -->
<div id="overlay" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="key" aria-hidden="true">
      <svg width="56" height="56" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
        <defs><linearGradient id="k" x1="0" x2="1"><stop offset="0" stop-color="#ffd166"/><stop offset="1" stop-color="#f4a261"/></linearGradient></defs>
        <path d="M44 24a12 12 0 1 0-8.485 11.314L43 31.828V36h4v6h-4v4h-4v-4h-4v4h-6l-9 9v-6H8v-8h8v-6h6v-6l2-2.001A12 12 0 0 0 44 24z" fill="url(#k)"/>
      </svg>
    </div>
    <h3 id="modalTitle">Key #3 Received!</h3>
    <p>Screenshot this page to claim your prize.</p>
    <div class="scoreline">
      <span>Final Score: <span id="finalScore">0</span></span>
      <span>Final Streak: <span id="finalStreak">0</span></span>
    </div>
    <div style="margin-top:14px;display:flex;gap:10px;justify-content:center;">
      <button id="closeModal" class="btn ghost" aria-label="Close">Close</button>
    </div>
  </div>
</div>

<script>
/* =========================
   SETTINGS
   ========================= */
const SCORE_CORRECT = 10;
const SCORE_WRONG = -5;

// Overall timer (starts on first interaction)
const TOTAL_TIME_SECONDS = 240; // 4 minutes

// Tick rate for needle animation
const TICK_MS = 16; // ~60fps

// Round definitions
const ROUND_COUNT = 3;

// Round 1 (slightly slower)
const ROUND1_SYSTEMS = 2;
const ROUND1_SPEEDS = [0.85, 1.05];

// Round 2 (faster + more systems)
const ROUND2_SYSTEMS = 2;
const ROUND2_SPEEDS = [1.25, 1.45];

// Round 3 (hard mode)
const ROUND3_SYSTEMS = 3;
const ROUND3_SPEEDS = [1.65, 1.85, 2.05];
const ROUND3_ZONE_LEFT = 44;   // smaller zone
const ROUND3_ZONE_RIGHT = 56;  // smaller zone

/* =========================
   DOM
   ========================= */
const headerTitleEl = document.getElementById('headerTitle');
const roundPillEl = document.getElementById('roundPill');
const roundTitleEl = document.getElementById('roundTitle');
const roundDescEl = document.getElementById('roundDesc');
const scoringNoteEl = document.getElementById('scoringNote');

const tracksArea = document.getElementById('tracksArea');
const actionBtn = document.getElementById('actionBtn');
const resetBtn = document.getElementById('resetBtn');

const scoreEl = document.getElementById('scoreValue');
const scoreDeltaEl = document.getElementById('scoreDelta');
const streakEl = document.getElementById('streakValue');
const attemptsEl = document.getElementById('attempts');
const doneEl = document.getElementById('doneCount');
const totalEl = document.getElementById('totalCount');
const streakBadge = document.getElementById('streakBadge');

const toastEl = document.getElementById('toast');

const timerBox = document.getElementById('timerBox');
const timerDisplay = document.getElementById('timer');

const timeUpBar = document.getElementById('timeUpBar');
const restartBtn = document.getElementById('restartBtn');

const confettiCanvas = document.getElementById('confetti');

const forging = document.getElementById('forging');
const forgeFill = document.getElementById('forgeFill');

const overlay = document.getElementById('overlay');
const closeModal = document.getElementById('closeModal');
const finalScoreEl = document.getElementById('finalScore');
const finalStreakEl = document.getElementById('finalStreak');

/* =========================
   STATE
   ========================= */
let round = 1;
let attempts = 0;
let score = 0;
let streak = 0;
let streakBoostApplied = false;

let trackState = [];
let trackTimers = [];
let gameLocked = false;

// Timer
let timeLeft = TOTAL_TIME_SECONDS;
let timerStarted = false;
let timerInterval = null;

/* =========================
   TIMER
   ========================= */
function formatTime(sec){
  const m = Math.floor(sec / 60);
  const s = sec % 60;
  return `${m}:${String(s).padStart(2,'0')}`;
}
function updateTimerUI(){
  timerDisplay.textContent = formatTime(timeLeft);
  timerBox.classList.remove('warning','danger');
  if (timeLeft <= 60 && timeLeft > 20) timerBox.classList.add('warning');
  if (timeLeft <= 20) timerBox.classList.add('danger');
}
function startTimerIfNeeded(){
  if (timerStarted) return;
  timerStarted = true;
  timerInterval = setInterval(()=> {
    if (timeLeft <= 0){
      timeLeft = 0;
      updateTimerUI();
      stopTimer();
      handleTimeUp();
      return;
    }
    timeLeft--;
    updateTimerUI();
  }, 1000);
}
function stopTimer(){
  if (timerInterval){
    clearInterval(timerInterval);
    timerInterval = null;
  }
}
function resetTimer(){
  stopTimer();
  timerStarted = false;
  timeLeft = TOTAL_TIME_SECONDS;
  updateTimerUI();
  timerBox.classList.remove('warning','danger');
}
function handleTimeUp(){
  gameLocked = true;
  actionBtn.disabled = true;
  stopAllTracks();
  timeUpBar.style.display = 'flex';
}

/* =========================
   TOAST
   ========================= */
let toastT = null;
function showToast(msg){
  clearTimeout(toastT);
  toastEl.textContent = msg;
  toastEl.classList.add('show');
  toastT = setTimeout(()=> toastEl.classList.remove('show'), 1400);
}

/* =========================
   ZONE CHECK
   ========================= */
function isInGreenZone(pos){
  if (round !== 3) return pos > 41 && pos < 59;
  return pos > ROUND3_ZONE_LEFT && pos < ROUND3_ZONE_RIGHT;
}

/* =========================
   TRACK ANIMATION
   ========================= */
function tickTrack(i){
  const t = trackState[i];
  if (!t || t.locked) return;

  t.pos += t.dir * t.speed;
  if (t.pos >= 100){ t.pos = 100; t.dir = -1; }
  if (t.pos <= 0){ t.pos = 0; t.dir = 1; }

  if (t.needleEl){
    t.needleEl.style.left = `${t.pos}%`;
  }
}
function stopAllTracks(){
  trackTimers.forEach(id => clearInterval(id));
  trackTimers = [];
}

/* =========================
   SCORING / STREAK
   ========================= */
function bumpScore(delta){
  const prev = score;
  if (delta > 0) score += delta;
  else score = Math.max(0, score + delta);

  scoreEl.textContent = score;
  scoreEl.classList.add('bump');

  scoreDeltaEl.className = '';
  scoreDeltaEl.textContent = (delta > 0 ? `+${delta}` : `${delta}`);
  scoreDeltaEl.classList.add('show', delta > 0 ? 'positive' : 'negative');

  setTimeout(()=> scoreEl.classList.remove('bump'), 260);
  setTimeout(()=> scoreDeltaEl.classList.remove('show','positive','negative'), 700);
}
function showStreakBadge(){
  streakBadge.classList.add('show');
  setTimeout(()=> streakBadge.classList.remove('show'), 2000);
}
function applyStreakBonusIfNeeded(){
  const target = 4;
  const multiplier = 1.5;
  if (streak >= target && !streakBoostApplied){
    streakBoostApplied = true;
    score = Math.round(score * multiplier);
    scoreEl.textContent = score;
    scoreEl.classList.add('bump');
    showStreakBadge();
    showToast(`Streak bonus! Score Ã—${multiplier}`);
    setTimeout(()=> scoreEl.classList.remove('bump'), 260);
  }
}
function handleWrong(){
  streak = 0;
  streakBoostApplied = false;
  streakEl.textContent = streak;
  bumpScore(SCORE_WRONG);
}

/* =========================
   VISUAL FEEDBACK
   ========================= */
function applyCorrectVisual(el){
  if (!el) return;
  el.classList.remove('flashBad');
  el.classList.add('flashGood');
  setTimeout(()=> el.classList.remove('flashGood'), 360);
}
function applyWrongVisual(el){
  if (!el) return;
  el.classList.remove('flashGood');
  el.classList.add('flashBad');
  setTimeout(()=> el.classList.remove('flashBad'), 320);
}

/* =========================
   BUILD ROUNDS
   ========================= */
function buildRound1(){
  document.body.classList.remove('round3');
  stopAllTracks();
  trackState = [];

  headerTitleEl.textContent = 'System Calibration Challenge';
  roundPillEl.textContent = 'Round 1 / 3';
  roundTitleEl.textContent = 'Round 1 â€” Warmup Locks';
  roundDescEl.innerHTML = 'Lock each system by tapping <strong>LOCK</strong> when the needle is inside the green zone. (Slightly slower)';
  scoringNoteEl.innerHTML =
    'Scoring: Successful lock <strong>+10</strong>, unsuccessful lock <strong>-5</strong> (never below 0). '+
    'Get <strong>4</strong> successful locks in a row to trigger a <strong>1.5Ã—</strong> score boost!';

  tracksArea.innerHTML = '';
  for (let i=0;i<ROUND1_SYSTEMS;i++){
    tracksArea.insertAdjacentHTML('beforeend', trackHTML(i));
  }

  for (let i=0;i<ROUND1_SYSTEMS;i++){
    initTrack(i, ROUND1_SPEEDS[i]);
  }

  totalEl.textContent = String(ROUND1_SYSTEMS);
  doneEl.textContent = '0';
  actionBtn.disabled = false;
  actionBtn.textContent = 'LOCK';
}

function buildRound2(){
  document.body.classList.remove('round3');
  stopAllTracks();
  trackState = [];

  roundPillEl.textContent = 'Round 2 / 3';
  roundTitleEl.textContent = 'Round 2 â€” Dual Systems';
  roundDescEl.innerHTML = 'Systems run faster. Keep your streak and score â€” tap <strong>LOCK</strong> precisely.';
  scoringNoteEl.innerHTML =
    'Scoring: Successful lock <strong>+10</strong>, unsuccessful lock <strong>-5</strong> (never below 0). '+
    'Get <strong>4</strong> successful locks in a row to trigger a <strong>1.5Ã—</strong> score boost!';

  tracksArea.innerHTML = '';
  for (let i=0;i<ROUND2_SYSTEMS;i++){
    tracksArea.insertAdjacentHTML('beforeend', trackHTML(i));
  }

  for (let i=0;i<ROUND2_SYSTEMS;i++){
    initTrack(i, ROUND2_SPEEDS[i]);
  }

  totalEl.textContent = String(ROUND2_SYSTEMS);
  doneEl.textContent = '0';
  actionBtn.disabled = false;
  actionBtn.textContent = 'LOCK';
}

function buildRound3(){
  document.body.classList.add('round3');
  stopAllTracks();
  trackState = [];

  roundPillEl.textContent = 'Round 3 / 3';
  roundTitleEl.textContent = 'Round 3 â€” Overheat Protocol';
  roundDescEl.innerHTML =
    'Pick a system (A/B/C) then tap <strong>LOCK TARGET</strong> inside the (smaller) green zone. '+
    'Misses cause <strong>overheat</strong>: you must land <strong>two successful locks in a row</strong> on that system to recover.';
  scoringNoteEl.innerHTML =
    'Scoring: Successful lock <strong>+10</strong>, unsuccessful lock <strong>-5</strong> (never below 0). '+
    'Get <strong>4</strong> successful locks in a row to trigger a <strong>1.5Ã—</strong> score boost!';

  // Target picker
  tracksArea.innerHTML = `
    <div class="controls" style="margin-top:0;margin-bottom:10px;">
      <button class="btn ghost" id="pickA" type="button">Target: A</button>
      <button class="btn ghost" id="pickB" type="button">Target: B</button>
      <button class="btn ghost" id="pickC" type="button">Target: C</button>
      <span class="pill" id="targetPill" style="min-width:auto;">Target: A</span>
    </div>
  `;

  let html = '';
  for (let i=0;i<ROUND3_SYSTEMS;i++){
    html += trackHTML(i, true);
  }
  tracksArea.insertAdjacentHTML('beforeend', html);

  // Default target
  window.__targetIdx = 0;
  const targetPill = document.getElementById('targetPill');
  const setTarget = (idx)=>{
    window.__targetIdx = idx;
    targetPill.textContent = `Target: ${String.fromCharCode(65+idx)}`;
  };
  document.getElementById('pickA').addEventListener('click', ()=>setTarget(0));
  document.getElementById('pickB').addEventListener('click', ()=>setTarget(1));
  document.getElementById('pickC').addEventListener('click', ()=>setTarget(2));

  for (let i=0;i<ROUND3_SYSTEMS;i++){
    initTrack(i, ROUND3_SPEEDS[i], true);
  }

  totalEl.textContent = String(ROUND3_SYSTEMS);
  doneEl.textContent = '0';
  actionBtn.disabled = false;
  actionBtn.textContent = 'LOCK TARGET';
}

function trackHTML(i, includeState=false){
  const sysLabel = round === 3 ? `System ${String.fromCharCode(65+i)}` : `System ${i+1}`;
  return `
    <div class="trackWrap" id="wrap${i}">
      <div class="trackLabel">
        <div>${sysLabel}</div>
        <div class="lockState" id="lockState${i}">Not locked</div>
      </div>
      <div class="track" id="track${i}">
        <div class="zone"></div>
        <div class="needle" id="needle${i}" style="left:50%"></div>
      </div>
    </div>
  `;
}

function initTrack(i, speed, isRound3=false){
  const wrapEl = document.getElementById(`wrap${i}`);
  const trackEl = document.getElementById(`track${i}`);
  const needleEl = document.getElementById(`needle${i}`);

  trackState.push({
    pos: Math.random()*100,
    dir: Math.random() > 0.5 ? 1 : -1,
    locked: false,
    speed,
    wrapEl,
    trackEl,
    needleEl,
    overheated: false,
    consecOk: 0
  });

  trackTimers.push(setInterval(()=>tickTrack(i), TICK_MS));
}

/* =========================
   LOCK LOGIC
   ========================= */
function lockFirstUnlockedTrack(){
  if (round !== 3){
    const idx = trackState.findIndex(t => !t.locked);
    if (idx === -1) return {done:true};
    return attemptLockAtIndex(idx);
  }

  const idx = window.__targetIdx ?? 0;
  if (!trackState[idx] || trackState[idx].locked){
    showToast('That system is already locked.');
    return {done:false};
  }
  return attemptLockAtIndex(idx);
}

function attemptLockAtIndex(idx){
  const s = trackState[idx];
  const ok = isInGreenZone(s.pos);

  attempts++;
  attemptsEl.textContent = attempts;

  if (ok){
    // Round 3 overheated recovery: need 2 consecutive OK to recover
    if (round === 3 && s.overheated){
      s.consecOk++;
      applyCorrectVisual(s.wrapEl);
      bumpScore(SCORE_CORRECT);

      streak++; streakEl.textContent = streak;
      applyStreakBonusIfNeeded();

      showToast(`Successful lock! +10 (cooling ${s.consecOk}/2)`);

      if (s.consecOk >= 2){
        s.overheated = false;
        s.consecOk = 0;
        s.wrapEl.classList.remove('overheated');
        document.getElementById(`lockState${idx}`).textContent = 'Recovered âœ…';
      }
      return {done:false, correct:true};
    }

    // Normal success: lock it
    s.locked = true;
    s.wrapEl.classList.add('locked');
    document.getElementById(`lockState${idx}`).textContent = 'Locked âœ…';

    bumpScore(SCORE_CORRECT);
    streak++; streakEl.textContent = streak;
    applyStreakBonusIfNeeded();

    applyCorrectVisual(s.wrapEl);
    showToast('Successful lock! +10');

    const done = trackState.filter(t => t.locked).length;
    doneEl.textContent = String(done);

    if (done === trackState.length) return {done:true, correct:true};
    return {done:false, correct:true};
  }

  // Miss
  if (round === 3){
    s.overheated = true;
    s.consecOk = 0;
    s.wrapEl.classList.add('overheated');
    document.getElementById(`lockState${idx}`).textContent = 'Overheated ðŸ”¥';
  }

  handleWrong();
  applyWrongVisual(s.wrapEl);
  showToast('Unsuccessful lock! -5');
  return {done:false, correct:false};
}

/* =========================
   ROUND FLOW
   ========================= */
function finishGame(){
  gameLocked = true;
  actionBtn.disabled = true;
  stopAllTracks();
  stopTimer(); // âœ… stop timer on completion
  showForgingThenPopup();
}

/* =========================
   FORGING + POPUP
   ========================= */
function showForgingThenPopup(){
  // optional confetti
  fireConfetti();

  // forging
  forgeFill.style.width = '0%';
  forging.style.display = 'flex';
  forging.setAttribute('aria-hidden','false');
  setTimeout(()=> forgeFill.style.width = '100%', 60);

  setTimeout(()=> {
    forging.style.display = 'none';
    forging.setAttribute('aria-hidden','true');

    finalScoreEl.textContent = score;
    finalStreakEl.textContent = streak;

    overlay.classList.add('show');
    overlay.setAttribute('aria-hidden','false');
  }, 1400);
}

closeModal.addEventListener('click', ()=>{
  overlay.classList.remove('show');
  overlay.setAttribute('aria-hidden','true');
});

/* =========================
   CONFETTI
   ========================= */
const confettiCtx = confettiCanvas.getContext('2d');
function fireConfetti(){
  const ctx = confettiCtx;
  const w = confettiCanvas.width = window.innerWidth;
  const h = confettiCanvas.height = window.innerHeight;
  confettiCanvas.style.display = 'block';

  const pieces = [];
  const count = Math.floor(Math.min(140, w/5));
  for(let i=0;i<count;i++){
    pieces.push({
      x: Math.random()*w,
      y: Math.random()*-h*0.4,
      w: 6 + Math.random()*10,
      h: 6 + Math.random()*10,
      vx: -2 + Math.random()*4,
      vy: 2 + Math.random()*6,
      rot: Math.random()*360,
      speed: 0.02 + Math.random()*0.06,
      color: ['#2563eb','#ef4444','#10b981','#f59e0b','#7c3aed'][Math.floor(Math.random()*5)]
    });
  }

  let t0 = performance.now();
  const start = t0;
  function render(t){
    t0 = t;
    ctx.clearRect(0,0,w,h);
    for(let p of pieces){
      p.x += p.vx;
      p.y += p.vy;
      p.rot += p.speed*30;
      ctx.save();
      ctx.translate(p.x,p.y);
      ctx.rotate(p.rot*Math.PI/180);
      ctx.fillStyle = p.color;
      ctx.fillRect(-p.w/2,-p.h/2,p.w,p.h);
      ctx.restore();
    }
    if ((t - start) < 2600) requestAnimationFrame(render);
    else {
      confettiCanvas.style.display = 'none';
      ctx.clearRect(0,0,w,h);
    }
  }
  requestAnimationFrame(render);
}

window.addEventListener('resize', ()=> {
  if (confettiCanvas.style.display !== 'none'){
    confettiCanvas.width = window.innerWidth;
    confettiCanvas.height = window.innerHeight;
  }
});

/* =========================
   RESET / RESTART
   ========================= */
function hardReset(){
  // core state
  gameLocked = false;
  round = 1;

  attempts = 0;
  score = 0;
  streak = 0;
  streakBoostApplied = false;

  attemptsEl.textContent = attempts;
  scoreEl.textContent = score;
  streakEl.textContent = streak;

  // UI
  timeUpBar.style.display = 'none';
  overlay.classList.remove('show');
  forging.style.display = 'none';

  // timer
  resetTimer();

  // tracks
  buildRound1();

  showToast('Ready! Tap LOCK to start the timer.');
}

resetBtn.addEventListener('click', hardReset);
restartBtn.addEventListener('click', hardReset);

/* =========================
   EVENTS
   ========================= */
actionBtn.addEventListener('click', ()=>{
  if (gameLocked) return;
  startTimerIfNeeded();

  const result = lockFirstUnlockedTrack();
  if (result && result.done){
    actionBtn.disabled = true;
    setTimeout(()=> {
      actionBtn.disabled = false;

      if (round === 1){
        round = 2;
        buildRound2();
        showToast('Round 2 started!');
      } else if (round === 2){
        round = 3;
        buildRound3();
        showToast('Round 3 started!');
      } else {
        finishGame();
      }
    }, 650);
  }
});

/* =========================
   INIT
   ========================= */
updateTimerUI();
hardReset();
</script>
</body>
</html>
