<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>System Calibration â€” SEG Open House</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
  :root{
    --bg1:#0f172a; --bg2:#1e293b;
    --card-bg: rgba(255,255,255,0.04);
    --accent-500:#2563eb;
    --accent-400:#3b82f6;
    --muted:#9aa6c0;
    --success:#10b981;
    --danger:#ef4444;
    --warn:#facc15;
    --card-radius:16px;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family:"Poppins",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    color:#e6eef8;
    background: linear-gradient(135deg,var(--bg1),var(--bg2));
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    padding:20px;
    display:flex;
    justify-content:center;
  }
  .stage{width:100%;max-width:980px;}

  header{
    display:flex;
    gap:16px;
    align-items:stretch;
    margin-bottom:18px;
    flex-wrap:wrap;
    justify-content:space-between;
  }
  .hero{
    flex:1;
    background: linear-gradient(90deg, rgba(59,130,246,0.06), rgba(37,99,235,0.03));
    border-radius:12px;
    padding:16px;
    box-shadow: 0 6px 20px rgba(2,6,23,.06);
    display:flex;
    align-items:center;
    gap:14px;
    min-width:0;
  }
  .logo{
    width:56px;height:56px;border-radius:12px;
    display:flex;align-items:center;justify-content:center;
    background:linear-gradient(135deg,var(--accent-500),var(--accent-400));
    color:white;font-weight:700;font-size:20px;
    box-shadow: 0 6px 18px rgba(59,130,246,0.18);
    flex:0 0 56px;
  }
  .hero-text h1{margin:0;font-size:1.05rem}
  .hero-text p{margin:4px 0 0;color:var(--muted);font-size:.9rem}

  #timerBox{
    background: rgba(15,23,42,0.85);
    border-radius:12px;
    padding:10px 14px;
    display:flex;
    flex-direction:column;
    justify-content:center;
    align-items:flex-start;
    min-width:130px;
    box-shadow:0 8px 26px rgba(2,6,23,0.6);
    border:1px solid rgba(148,163,184,0.2);
  }
  #timerLabel{font-size:.8rem;color:var(--muted);}
  #timer{font-size:1.3rem;font-weight:700;color:#22c55e;}
  #timerBox.warning #timer{color:var(--warn);}
  #timerBox.danger #timer{color:#fb7185;}

  main{margin-top:4px;}

  .card{
    background:var(--card-bg);
    border-radius:var(--card-radius);
    padding:16px;
    box-shadow: 0 14px 44px rgba(2,6,23,.28);
    border:1px solid rgba(255,255,255,0.03);
  }

  .top-bar{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
    flex-wrap:wrap;
    margin-bottom:10px;
  }
  .pill{
    font-size:.78rem;
    padding:6px 12px;
    border-radius:999px;
    background:rgba(15,23,42,0.85);
    border:1px solid rgba(148,163,184,0.55);
    color:#cbd5f5;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    min-width:110px;
    white-space:nowrap;
    text-align:center;
  }

  #streakBadge{
    font-size:.85rem;
    padding:6px 10px;
    border-radius:999px;
    background:rgba(34,197,94,0.12);
    color:#bbf7d0;
    border:1px solid rgba(34,197,94,0.3);
    opacity:0;
    transform:translateY(6px);
    transition:opacity .2s ease, transform .2s ease;
  }
  #streakBadge.show{opacity:1; transform:translateY(0);}

  .round-title{margin:6px 0 0;font-size:1.02rem;color:#e6f0ff;font-weight:700;}
  .round-desc{margin:6px 0 0;color:var(--muted);font-size:.92rem;line-height:1.5;}

  /* Rules callout */
  .rules{
    margin-top:10px;
    padding:12px;
    border-radius:12px;
    border:1px solid rgba(59,130,246,0.25);
    background:linear-gradient(90deg, rgba(59,130,246,0.08), rgba(15,23,42,0.35));
    display:flex;
    gap:10px;
    align-items:flex-start;
  }
  .rules .badge{
    flex:0 0 auto;
    font-weight:800;
    color:#dbeafe;
    background:rgba(59,130,246,0.22);
    border:1px solid rgba(59,130,246,0.35);
    padding:6px 10px;
    border-radius:999px;
    font-size:.85rem;
  }
  .rules .text{
    color:#e6eef8;
    font-size:.92rem;
    line-height:1.5;
  }
  .rules .text b{color:#ffffff}
  .rules .mini{color:var(--muted);font-size:.85rem;margin-top:4px;}

  #tracksArea{margin-top:14px;}

  .trackWrap{
    margin:12px 0;
    padding:12px;
    border-radius:12px;
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border:1px solid rgba(255,255,255,0.04);
    will-change: transform;
  }
  .trackLabel{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:12px;
    font-size:.95rem;
    margin-bottom:10px;
  }
  .lockState{color:var(--muted); font-size:.85rem;}

  .track{
    position:relative;
    height:18px;
    border-radius:999px;
    background: rgba(148,163,184,0.12);
    overflow:hidden;
    box-shadow: inset 0 2px 8px rgba(0,0,0,0.25);
  }
  .zone{
    position:absolute;
    top:0; height:100%;
    left:41%;
    width:18%;
    border-radius:999px;
    background: linear-gradient(90deg, rgba(16,185,129,0.35), rgba(16,185,129,0.18));
    border:1px solid rgba(16,185,129,0.45);
    box-shadow:0 0 18px rgba(16,185,129,0.22);
  }
  .round3 .zone{ left:44%; width:12%; }

  .needle{
    position:absolute;
    top:50%;
    width:12px;
    height:28px;
    transform:translate(-50%,-50%);
    border-radius:10px;
    background: linear-gradient(180deg,#e2e8f0,#94a3b8);
    box-shadow:0 10px 26px rgba(2,6,23,0.55);
    will-change: left;
  }

  .trackWrap.locked .track{
    background: rgba(16,185,129,0.12);
    border:1px solid rgba(16,185,129,0.25);
  }
  .trackWrap.locked .needle{
    background: linear-gradient(180deg,#10b981,#065f46);
  }
  .trackWrap.overheated .track{
    background: rgba(239,68,68,0.10);
    border:1px solid rgba(239,68,68,0.22);
  }

  /* Per-system action row (Rounds 1 & 2) */
  .trackActions{
    margin-top:10px;
    display:flex;
    gap:10px;
    align-items:center;
    flex-wrap:wrap;
  }
  .sysBtn{
    background:linear-gradient(180deg,var(--accent-400),var(--accent-500));
    color:white;
    padding:10px 14px;
    border-radius:12px;
    border:0;
    cursor:pointer;
    font-weight:900;
    box-shadow:0 10px 28px rgba(37,99,235,0.22);
    font-size:.95rem;
    letter-spacing:.4px;
    min-height:44px;
  }
  .sysBtn:disabled{opacity:.55;cursor:not-allowed;box-shadow:none;}
  .sysHint{
    color:var(--muted);
    font-size:.85rem;
  }

  /* Bottom controls */
  .controls{
    display:flex;
    gap:10px;
    align-items:center;
    margin-top:14px;
    flex-wrap:wrap;
  }
  .actionBtn{
    background:linear-gradient(180deg,var(--accent-400),var(--accent-500));
    color:white;
    padding:12px 16px;
    border-radius:12px;
    border:0;
    cursor:pointer;
    font-weight:900;
    box-shadow:0 10px 28px rgba(37,99,235,0.22);
    font-size:1rem;
    letter-spacing:.5px;
    min-height:48px;
  }
  .btn.ghost{
    background:transparent;
    color:var(--accent-400);
    border:1px solid rgba(59,130,246,0.3);
    box-shadow:none;
    padding:12px 16px;
    border-radius:12px;
    font-weight:900;
    cursor:pointer;
    min-height:48px;
  }
  .actionBtn:disabled, .btn.ghost:disabled{opacity:.5; cursor:not-allowed;}

  .stats{
    margin-left:auto;
    color:var(--muted);
    font-size:.85rem;
    display:flex;
    flex-direction:column;
    align-items:flex-end;
    gap:2px;
  }
  .stats-line{white-space:nowrap;}

  #scoreValue.bump{ animation:scoreBump .25s ease-out; }
  @keyframes scoreBump{0%{transform:scale(1);}50%{transform:scale(1.2);}100%{transform:scale(1);}}
  #scoreDelta{
    font-size:.8rem;
    margin-left:6px;
    opacity:0;
    transform:translateY(-4px);
    transition:opacity .2s ease, transform .2s ease;
  }
  #scoreDelta.show{opacity:1; transform:translateY(0);}
  #scoreDelta.positive{color:#4ade80;}
  #scoreDelta.negative{color:#fb7185;}

  .note{color:var(--muted);font-size:.85rem;margin-top:12px;line-height:1.5;}

  .flashGood{ animation:flashGood .35s ease-out; }
  .flashBad{ animation:flashBad .3s ease-out; }
  @keyframes flashGood{0%{transform:scale(1); box-shadow:0 0 0 rgba(16,185,129,0);}50%{transform:scale(1.01); box-shadow:0 0 18px rgba(16,185,129,0.55);}100%{transform:scale(1);}}
  @keyframes flashBad{0%{transform:translateX(0);}25%{transform:translateX(-4px);}50%{transform:translateX(4px);}75%{transform:translateX(-2px);}100%{transform:translateX(0);}}

  #toast{
    position:fixed;
    left:50%;
    transform:translateX(-50%);
    bottom:18px;
    background: rgba(15,23,42,0.92);
    border:1px solid rgba(148,163,184,0.25);
    color:#e6eef8;
    padding:10px 14px;
    border-radius:999px;
    box-shadow:0 12px 34px rgba(2,6,23,0.65);
    z-index:90;
    opacity:0;
    pointer-events:none;
    transition:opacity .18s ease, transform .18s ease;
    max-width:92%;
    text-align:center;
    font-size:.9rem;
  }
  #toast.show{opacity:1; transform:translateX(-50%) translateY(-4px);}

  #confetti{ position:fixed; inset:0; pointer-events:none; z-index:60; display:none; }

  #timeUpBar{
    position:fixed;
    left:50%;
    transform:translateX(-50%);
    bottom:16px;
    background:linear-gradient(90deg,#b91c1c,#ef4444);
    color:white;
    padding:10px 16px;
    border-radius:999px;
    display:none;
    align-items:center;
    gap:10px;
    box-shadow:0 10px 30px rgba(127,29,29,0.6);
    z-index:95;
    font-size:.9rem;
  }
  #timeUpBar button{
    background:white;
    color:#b91c1c;
    border:none;
    border-radius:999px;
    padding:6px 12px;
    font-weight:900;
    cursor:pointer;
  }

  #forging{
    position:fixed; inset:0;
    display:none;
    align-items:center;
    justify-content:center;
    z-index:110;
    background:linear-gradient(rgba(3,7,18,0.55), rgba(3,7,18,0.55));
  }
  #forging .box{
    width:360px; max-width:92%;
    background:linear-gradient(180deg,#071029,#081424);
    color:white;
    padding:18px;
    border-radius:12px;
    text-align:center;
    box-shadow:0 14px 40px rgba(2,6,23,.6);
    border:1px solid rgba(255,255,255,0.03);
  }
  .forge-bar{height:10px;background: rgba(255,255,255,0.06);border-radius:999px;overflow:hidden;margin-top:12px;}
  .forge-fill{height:100%;width:0%;background: linear-gradient(90deg,#ffd166,#f4a261);transition: width 1.2s ease;}

  #overlay{
    position:fixed; inset:0;
    display:none;
    align-items:center;
    justify-content:center;
    background:linear-gradient(rgba(3,7,18,0.55), rgba(3,7,18,0.55));
    z-index:120;
  }
  #overlay.show{display:flex;}
  .modal{
    width:100%; max-width:460px;
    background:linear-gradient(180deg,#0b1220,#071029);
    border-radius:14px;
    padding:22px;
    text-align:center;
    box-shadow:0 30px 80px rgba(2,6,23,.6);
    border:1px solid rgba(255,255,255,0.03);
    transform:translateY(8px);
    opacity:0;
    transition:transform .28s cubic-bezier(.2,.9,.2,1),opacity .18s;
  }
  #overlay.show .modal{transform:translateY(0); opacity:1;}
  .modal h3{margin:0;font-size:1.18rem;color:#ffd166;}
  .modal p{color:var(--muted);margin-top:8px;}
  .modal .key{
    width:96px;height:96px;margin:16px auto 8px;border-radius:16px;
    display:flex;align-items:center;justify-content:center;
    background:linear-gradient(135deg,#ffd166,#f4a261);
    box-shadow:0 12px 28px rgba(244,162,97,0.12);
  }
  .modal .scoreline{
    margin-top:10px;
    display:flex;
    justify-content:center;
    gap:10px;
    flex-wrap:wrap;
    color:#e6eef8;
    font-weight:900;
  }
  .modal .scoreline span{
    background:rgba(15,23,42,0.65);
    border:1px solid rgba(148,163,184,0.22);
    padding:6px 10px;
    border-radius:999px;
    font-size:.92rem;
  }

  /* ===== Mobile-first tweaks ===== */
  @media (max-width:780px){
    header{flex-direction:column;}
    #timerBox{align-self:flex-start;}
  }
  @media (max-width:640px){
    body{padding:14px;}
    .logo{width:48px;height:48px;}
    .hero-text h1{font-size:1rem;}
    .hero-text p{font-size:.9rem;}

    .stats{
      align-items:flex-start;
      margin-left:0;
      width:100%;
    }

    /* ðŸ”§ Controls now behave like normal content, not sticky overlay */
    .controls{
      flex-direction:column;
      align-items:stretch;
      gap:12px;
      margin-top:18px;
    }

    .controls .stats{
      order:-1;
    }

    .actionBtn, .btn.ghost{
      width:100%;
      border-radius:14px;
      font-size:1.05rem;
      padding:16px 16px;
    }

    .sysBtn{
      width:100%;
      border-radius:14px;
      font-size:1.05rem;
      padding:14px 14px;
    }
    .trackActions{
      flex-direction:column;
      align-items:stretch;
    }
    .sysHint{font-size:.88rem;}
  }
</style>
</head>

<body>
<div class="stage">
  <header>
    <div class="hero">
      <div class="logo">SEG</div>
      <div class="hero-text">
        <h1 id="headerTitle">System Calibration Challenge</h1>
        <p>Skill-based â€” lock systems when the needle is inside the green zone. Clear all rounds to collect <strong>Key #3</strong>.</p>
      </div>
    </div>
    <div id="timerBox">
      <span id="timerLabel">Time Left</span>
      <span id="timer">4:00</span>
    </div>
  </header>

  <main>
    <section class="card">
      <div class="top-bar">
        <div class="pill" id="roundPill">Round 1 / 3</div>
        <div id="streakBadge">Streak bonus applied!</div>
      </div>

      <div class="round-title" id="roundTitle">Round 1 â€” Warmup Locks</div>
      <div class="round-desc" id="roundDesc"></div>

      <div class="rules">
        <div class="badge">How to Play</div>
        <div class="text" id="rulesText"></div>
      </div>

      <div id="tracksArea" aria-live="polite"></div>

      <div class="controls">
        <!-- Visible ONLY in Round 3 -->
        <button id="actionBtn" class="actionBtn" aria-label="Lock Target">LOCK TARGET</button>

        <button id="resetBtn" class="btn ghost" aria-label="Reset game">Reset</button>

        <div class="stats" aria-live="polite">
          <div class="stats-line">
            <strong>Score:</strong>
            <span id="scoreValue">0</span>
            <span id="scoreDelta"></span>
          </div>
          <div class="stats-line">
            Streak: <span id="streakValue">0</span> &nbsp;â€¢&nbsp;
            Locked: <span id="doneCount">0</span>/<span id="totalCount">0</span>
          </div>
          <div class="stats-line">
            Attempts: <span id="attempts">0</span>
          </div>
        </div>
      </div>

      <p class="note" id="scoringNote"></p>
    </section>
  </main>
</div>

<canvas id="confetti"></canvas>
<div id="toast"></div>

<div id="timeUpBar">
  <span>Time's up! Restart to try again.</span>
  <button id="restartBtn">Restart</button>
</div>

<div id="forging" aria-hidden="true">
  <div class="box">
    <div style="font-weight:800;color:#ffd166;">Forging Key #3â€¦</div>
    <div style="margin-top:6px;color:var(--muted);font-size:.92rem;">Please wait</div>
    <div class="forge-bar"><div class="forge-fill" id="forgeFill"></div></div>
  </div>
</div>

<div id="overlay" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="key" aria-hidden="true">
      <svg width="56" height="56" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
        <defs><linearGradient id="k" x1="0" x2="1"><stop offset="0" stop-color="#ffd166"/><stop offset="1" stop-color="#f4a261"/></linearGradient></defs>
        <path d="M44 24a12 12 0 1 0-8.485 11.314L43 31.828V36h4v6h-4v4h-4v-4h-4v4h-6l-9 9v-6H8v-8h8v-6h6v-6l2-2.001A12 12 0 0 0 44 24z" fill="url(#k)"/>
      </svg>
    </div>
    <h3 id="modalTitle">Key #3 Received!</h3>
    <p>Screenshot this page to claim your prize.</p>
    <div class="scoreline">
      <span>Final Score: <span id="finalScore">0</span></span>
      <span>Longest Streak: <span id="finalStreak">0</span></span>
    </div>
    <div style="margin-top:14px;display:flex;gap:10px;justify-content:center;">
      <button id="closeModal" class="btn ghost" aria-label="Close">Close</button>
    </div>
  </div>
</div>

<script>
/* =========================
   SETTINGS
   ========================= */
const SCORE_CORRECT = 10;
const SCORE_WRONG = -5;
const TOTAL_TIME_SECONDS = 240; // 4 minutes

const ROUND1_SYSTEMS = 2;
const ROUND1_SPEEDS = [0.85, 1.05];

const ROUND2_SYSTEMS = 2;
const ROUND2_SPEEDS = [1.25, 1.45];

const ROUND3_SYSTEMS = 3;
// Slower than before (more playable)
const ROUND3_SPEEDS = [1.15, 1.30, 1.45];

const ROUND3_ZONE_LEFT = 44;
const ROUND3_ZONE_RIGHT = 56;

/* =========================
   DOM
   ========================= */
const headerTitleEl = document.getElementById('headerTitle');
const roundPillEl = document.getElementById('roundPill');
const roundTitleEl = document.getElementById('roundTitle');
const roundDescEl = document.getElementById('roundDesc');
const scoringNoteEl = document.getElementById('scoringNote');

const rulesTextEl = document.getElementById('rulesText');

const tracksArea = document.getElementById('tracksArea');
const actionBtn = document.getElementById('actionBtn');
const resetBtn = document.getElementById('resetBtn');

const scoreEl = document.getElementById('scoreValue');
const scoreDeltaEl = document.getElementById('scoreDelta');
const streakEl = document.getElementById('streakValue');
const attemptsEl = document.getElementById('attempts');
const doneEl = document.getElementById('doneCount');
const totalEl = document.getElementById('totalCount');
const streakBadge = document.getElementById('streakBadge');

const toastEl = document.getElementById('toast');

const timerBox = document.getElementById('timerBox');
const timerDisplay = document.getElementById('timer');

const timeUpBar = document.getElementById('timeUpBar');
const restartBtn = document.getElementById('restartBtn');

const confettiCanvas = document.getElementById('confetti');
const forging = document.getElementById('forging');
const forgeFill = document.getElementById('forgeFill');

const overlay = document.getElementById('overlay');
const closeModal = document.getElementById('closeModal');
const finalScoreEl = document.getElementById('finalScore');
const finalStreakEl = document.getElementById('finalStreak');

/* =========================
   STATE
   ========================= */
let round = 1;
let attempts = 0;
let score = 0;

let streak = 0;
let longestStreak = 0;
let streakBoostApplied = false;

let gameLocked = false;

// Timer
let timeLeft = TOTAL_TIME_SECONDS;
let timerStarted = false;
let timerInterval = null;

/* Tracks (1 RAF loop) */
let tracks = []; // {pos,dir,speed,locked,overheated,consecOk,wrapEl,needleEl,lockStateEl,btnEl}
let rafId = null;
let lastFrameTs = 0;

window.__targetIdx = 0;

/* =========================
   TIMER
   ========================= */
function formatTime(sec){
  const m = Math.floor(sec / 60);
  const s = sec % 60;
  return `${m}:${String(s).padStart(2,'0')}`;
}
function updateTimerUI(){
  timerDisplay.textContent = formatTime(timeLeft);
  timerBox.classList.remove('warning','danger');
  if (timeLeft <= 60 && timeLeft > 20) timerBox.classList.add('warning');
  if (timeLeft <= 20) timerBox.classList.add('danger');
}
function startTimerIfNeeded(){
  if (timerStarted) return;
  timerStarted = true;
  timerInterval = setInterval(()=> {
    if (timeLeft <= 0){
      timeLeft = 0;
      updateTimerUI();
      stopTimer();
      handleTimeUp();
      return;
    }
    timeLeft--;
    updateTimerUI();
  }, 1000);
}
function stopTimer(){
  if (timerInterval){
    clearInterval(timerInterval);
    timerInterval = null;
  }
}
function resetTimer(){
  stopTimer();
  timerStarted = false;
  timeLeft = TOTAL_TIME_SECONDS;
  updateTimerUI();
  timerBox.classList.remove('warning','danger');
}
function handleTimeUp(){
  gameLocked = true;
  actionBtn.disabled = true;
  // disable per-system buttons
  tracks.forEach(t => { if (t.btnEl) t.btnEl.disabled = true; });
  stopTracksAnimation();
  timeUpBar.style.display = 'flex';
}

/* =========================
   TOAST
   ========================= */
let toastT = null;
function showToast(msg){
  clearTimeout(toastT);
  toastEl.textContent = msg;
  toastEl.classList.add('show');
  toastT = setTimeout(()=> toastEl.classList.remove('show'), 1400);
}

/* =========================
   ZONE CHECK
   ========================= */
function isInGreenZone(pos){
  if (round !== 3) return pos > 41 && pos < 59;
  return pos > ROUND3_ZONE_LEFT && pos < ROUND3_ZONE_RIGHT;
}

/* =========================
   TRACK ANIMATION (RAF)
   speed is "% per 16ms"
   ========================= */
function startTracksAnimation(){
  stopTracksAnimation();
  lastFrameTs = performance.now();
  const loop = (ts)=>{
    rafId = requestAnimationFrame(loop);
    const dt = Math.min(48, ts - lastFrameTs);
    lastFrameTs = ts;
    const scale = dt / 16;

    for (let i=0;i<tracks.length;i++){
      const t = tracks[i];
      if (!t || t.locked) continue;

      t.pos += t.dir * t.speed * scale;
      if (t.pos >= 100){ t.pos = 100; t.dir = -1; }
      if (t.pos <= 0){ t.pos = 0; t.dir = 1; }

      t.needleEl.style.left = `${t.pos}%`;
    }
  };
  rafId = requestAnimationFrame(loop);
}
function stopTracksAnimation(){
  if (rafId){
    cancelAnimationFrame(rafId);
    rafId = null;
  }
}

/* =========================
   SCORING / STREAK
   ========================= */
function bumpScore(delta){
  if (delta > 0) score += delta;
  else score = Math.max(0, score + delta);

  scoreEl.textContent = score;
  scoreEl.classList.add('bump');

  scoreDeltaEl.className = '';
  scoreDeltaEl.textContent = (delta > 0 ? `+${delta}` : `${delta}`);
  scoreDeltaEl.classList.add('show', delta > 0 ? 'positive' : 'negative');

  setTimeout(()=> scoreEl.classList.remove('bump'), 260);
  setTimeout(()=> scoreDeltaEl.classList.remove('show','positive','negative'), 700);
}
function showStreakBadge(){
  streakBadge.classList.add('show');
  setTimeout(()=> streakBadge.classList.remove('show'), 2000);
}
function applyStreakBonusIfNeeded(){
  const target = 4;
  const multiplier = 1.5;
  if (streak >= target && !streakBoostApplied){
    streakBoostApplied = true;
    score = Math.round(score * multiplier);
    scoreEl.textContent = score;
    scoreEl.classList.add('bump');
    showStreakBadge();
    showToast(`Streak bonus! Score Ã—${multiplier}`);
    setTimeout(()=> scoreEl.classList.remove('bump'), 260);
  }
}
function addStreak(){
  streak++;
  if (streak > longestStreak) longestStreak = streak;
  streakEl.textContent = streak;
}
function handleWrong(){
  streak = 0;
  streakBoostApplied = false;
  streakEl.textContent = streak;
  bumpScore(SCORE_WRONG);
}

/* =========================
   VISUAL FEEDBACK
   ========================= */
function applyCorrectVisual(el){
  if (!el) return;
  el.classList.remove('flashBad');
  el.classList.add('flashGood');
  setTimeout(()=> el.classList.remove('flashGood'), 360);
}
function applyWrongVisual(el){
  if (!el) return;
  el.classList.remove('flashGood');
  el.classList.add('flashBad');
  setTimeout(()=> el.classList.remove('flashBad'), 320);
}

/* =========================
   UI BUILD HELPERS
   ========================= */
function trackHTML(i, perSystemButton){
  const sysLabel = round === 3 ? `System ${String.fromCharCode(65+i)}` : `System ${i+1}`;
  const btn = perSystemButton ? `
    <div class="trackActions">
      <button class="sysBtn" id="sysBtn${i}" type="button" aria-label="Lock ${sysLabel}">
        LOCK ${round === 3 ? 'TARGET' : (i+1)}
      </button>
      <div class="sysHint">Tap when the needle is inside the <b style="color:#bbf7d0">green zone</b>.</div>
    </div>
  ` : ``;

  return `
    <div class="trackWrap" id="wrap${i}">
      <div class="trackLabel">
        <div>${sysLabel}</div>
        <div class="lockState" id="lockState${i}">Not locked</div>
      </div>
      <div class="track" id="track${i}">
        <div class="zone"></div>
        <div class="needle" id="needle${i}" style="left:50%"></div>
      </div>
      ${btn}
    </div>
  `;
}

function initTracks(count, speeds, perSystemButtons){
  tracks = [];
  tracksArea.innerHTML = '';

  for (let i=0;i<count;i++){
    tracksArea.insertAdjacentHTML('beforeend', trackHTML(i, perSystemButtons));
  }

  for (let i=0;i<count;i++){
    const wrapEl = document.getElementById(`wrap${i}`);
    const needleEl = document.getElementById(`needle${i}`);
    const lockStateEl = document.getElementById(`lockState${i}`);
    const btnEl = perSystemButtons ? document.getElementById(`sysBtn${i}`) : null;

    const t = {
      pos: Math.random()*100,
      dir: Math.random() > 0.5 ? 1 : -1,
      locked: false,
      speed: speeds[i],
      wrapEl,
      needleEl,
      lockStateEl,
      btnEl,
      overheated: false,
      consecOk: 0
    };
    tracks.push(t);

    needleEl.style.left = `${t.pos}%`;

    if (btnEl){
      btnEl.textContent = `LOCK ${round === 3 ? 'TARGET' : (i+1)}`;
      btnEl.addEventListener('click', ()=>{
        if (gameLocked) return;
        startTimerIfNeeded();
        if (tracks[i].locked){
          showToast('That system is already locked.');
          return;
        }
        const result = attemptLockAtIndex(i);
        if (result && result.done){
          // Advance rounds if all done
          setTimeout(()=> {
            if (round === 1){
              buildRound2();
              showToast('Round 2 started!');
            } else if (round === 2){
              buildRound3();
              showToast('Round 3 started!');
            } else {
              finishGame();
            }
          }, 650);
        }
      });
    }
  }

  totalEl.textContent = String(count);
  doneEl.textContent = '0';

  startTracksAnimation();
}

/* =========================
   RULES TEXT
   ========================= */
function setRulesForRound(){
  if (round === 1){
    rulesTextEl.innerHTML = `
      <b>Round 1:</b> Each system has its own <b>LOCK</b> button.<br/>
      Tap <b>LOCK</b> when the needle is inside the <b>green zone</b>.
      <div class="mini">+10 success â€¢ -5 miss â€¢ 4 streak = 1.5Ã— bonus.</div>
    `;
  } else if (round === 2){
    rulesTextEl.innerHTML = `
      <b>Round 2:</b> Same rule, faster needles.<br/>
      Tap each systemâ€™s <b>LOCK</b> button inside the <b>green zone</b>.
      <div class="mini">+10 success â€¢ -5 miss â€¢ 4 streak = 1.5Ã— bonus.</div>
    `;
  } else {
    rulesTextEl.innerHTML = `
      <b>Round 3:</b> Pick a target (A/B/C) then tap <b>LOCK TARGET</b> inside the green zone.<br/>
      <div class="mini">Miss = <b>Overheat</b> ðŸ”¥. Land <b>2 successes in a row</b> on that system to recover.</div>
    `;
  }
}

/* =========================
   ROUND BUILDERS
   ========================= */
function buildRound1(){
  document.body.classList.remove('round3');
  round = 1;

  headerTitleEl.textContent = 'System Calibration Challenge';
  roundPillEl.textContent = 'Round 1 / 3';
  roundTitleEl.textContent = 'Round 1 â€” Warmup Locks';
  roundDescEl.innerHTML = 'Each system has its own <strong>LOCK</strong> button. Tap when the needle is inside the green zone. (Slower)';
  scoringNoteEl.innerHTML =
    'Scoring: Successful lock <strong>+10</strong>, unsuccessful lock <strong>-5</strong> (never below 0). '+
    'Get <strong>4</strong> successful locks in a row to trigger a <strong>1.5Ã—</strong> score boost!';

  // Round 1/2: hide global action button (use per-system buttons)
  actionBtn.style.display = 'none';
  actionBtn.disabled = true;

  setRulesForRound();
  initTracks(ROUND1_SYSTEMS, ROUND1_SPEEDS, true);
}

function buildRound2(){
  document.body.classList.remove('round3');
  round = 2;

  roundPillEl.textContent = 'Round 2 / 3';
  roundTitleEl.textContent = 'Round 2 â€” Dual Systems';
  roundDescEl.innerHTML = 'Faster needles. Each system has its own <strong>LOCK</strong> button â€” be precise!';
  scoringNoteEl.innerHTML =
    'Scoring: Successful lock <strong>+10</strong>, unsuccessful lock <strong>-5</strong> (never below 0). '+
    'Get <strong>4</strong> successful locks in a row to trigger a <strong>1.5Ã—</strong> score boost!';

  actionBtn.style.display = 'none';
  actionBtn.disabled = true;

  setRulesForRound();
  initTracks(ROUND2_SYSTEMS, ROUND2_SPEEDS, true);
}

function buildRound3(){
  document.body.classList.add('round3');
  round = 3;

  roundPillEl.textContent = 'Round 3 / 3';
  roundTitleEl.textContent = 'Round 3 â€” Overheat Protocol';
  roundDescEl.innerHTML =
    'Pick a system (A/B/C), then tap <strong>LOCK TARGET</strong> when the needle is inside the (smaller) green zone. '+
    'Misses cause <strong>overheat</strong>: land <strong>two successful locks in a row</strong> on that system to recover.';
  scoringNoteEl.innerHTML =
    'Scoring: Successful lock <strong>+10</strong>, unsuccessful lock <strong>-5</strong> (never below 0). '+
    'Get <strong>4</strong> successful locks in a row to trigger a <strong>1.5Ã—</strong> score boost!';

  setRulesForRound();

  // Show global action button for Round 3
  actionBtn.style.display = '';
  actionBtn.disabled = false;
  actionBtn.textContent = 'LOCK TARGET';

  // Target picker + tracks
  tracksArea.innerHTML = `
    <div class="controls" style="margin-top:0;margin-bottom:10px;">
      <button class="btn ghost" id="pickA" type="button">Target: A</button>
      <button class="btn ghost" id="pickB" type="button">Target: B</button>
      <button class="btn ghost" id="pickC" type="button">Target: C</button>
      <span class="pill" id="targetPill" style="min-width:auto;">Target: A</span>
    </div>
  `;

  const holder = document.createElement('div');
  holder.innerHTML = Array.from({length: ROUND3_SYSTEMS}, (_,i)=>trackHTML(i, false)).join('');
  tracksArea.appendChild(holder);

  window.__targetIdx = 0;
  const targetPill = document.getElementById('targetPill');
  const setTarget = (idx)=>{
    window.__targetIdx = idx;
    targetPill.textContent = `Target: ${String.fromCharCode(65+idx)}`;
    showToast(`Target set: ${String.fromCharCode(65+idx)}`);
  };
  document.getElementById('pickA').addEventListener('click', ()=>setTarget(0));
  document.getElementById('pickB').addEventListener('click', ()=>setTarget(1));
  document.getElementById('pickC').addEventListener('click', ()=>setTarget(2));

  // Init track objects
  tracks = [];
  for (let i=0;i<ROUND3_SYSTEMS;i++){
    const wrapEl = document.getElementById(`wrap${i}`);
    const needleEl = document.getElementById(`needle${i}`);
    const lockStateEl = document.getElementById(`lockState${i}`);

    const t = {
      pos: Math.random()*100,
      dir: Math.random() > 0.5 ? 1 : -1,
      locked: false,
      speed: ROUND3_SPEEDS[i],
      wrapEl,
      needleEl,
      lockStateEl,
      btnEl: null,
      overheated: false,
      consecOk: 0
    };
    tracks.push(t);
    needleEl.style.left = `${t.pos}%`;
  }

  totalEl.textContent = String(ROUND3_SYSTEMS);
  doneEl.textContent = '0';

  startTracksAnimation();
}

/* =========================
   LOCK LOGIC
   ========================= */
function attemptLockAtIndex(idx){
  const s = tracks[idx];
  const ok = isInGreenZone(s.pos);

  attempts++;
  attemptsEl.textContent = attempts;

  if (ok){
    // Round 3 overheated recovery: need 2 consecutive OK to recover
    if (round === 3 && s.overheated){
      s.consecOk++;
      applyCorrectVisual(s.wrapEl);
      bumpScore(SCORE_CORRECT);

      addStreak();
      applyStreakBonusIfNeeded();

      showToast(`Successful lock! +10 (cooling ${s.consecOk}/2)`);

      if (s.consecOk >= 2){
        s.overheated = false;
        s.consecOk = 0;
        s.wrapEl.classList.remove('overheated');
        s.lockStateEl.textContent = 'Recovered âœ…';
      }
      return {done:false, correct:true};
    }

    // Normal success: lock it
    s.locked = true;
    s.wrapEl.classList.add('locked');
    s.lockStateEl.textContent = 'Locked âœ…';
    if (s.btnEl){
      s.btnEl.disabled = true;
      s.btnEl.textContent = 'LOCKED âœ…';
    }

    bumpScore(SCORE_CORRECT);
    addStreak();
    applyStreakBonusIfNeeded();

    applyCorrectVisual(s.wrapEl);
    showToast('Successful lock! +10');

    const done = tracks.filter(t => t.locked).length;
    doneEl.textContent = String(done);

    if (done === tracks.length) return {done:true, correct:true};
    return {done:false, correct:true};
  }

  // Miss
  if (round === 3){
    s.overheated = true;
    s.consecOk = 0;
    s.wrapEl.classList.add('overheated');
    s.lockStateEl.textContent = 'Overheated ðŸ”¥';
  }

  handleWrong();
  applyWrongVisual(s.wrapEl);
  showToast('Unsuccessful lock! -5');
  return {done:false, correct:false};
}

function lockTargetRound3(){
  const idx = window.__targetIdx ?? 0;
  if (!tracks[idx] || tracks[idx].locked){
    showToast('That system is already locked.');
    return {done:false};
  }
  return attemptLockAtIndex(idx);
}

/* =========================
   FINISH
   ========================= */
function finishGame(){
  gameLocked = true;
  actionBtn.disabled = true;
  tracks.forEach(t => { if (t.btnEl) t.btnEl.disabled = true; });
  stopTracksAnimation();
  stopTimer();
  showForgingThenPopup();
}

/* =========================
   FORGING + POPUP
   ========================= */
function showForgingThenPopup(){
  fireConfetti();

  forgeFill.style.width = '0%';
  forging.style.display = 'flex';
  forging.setAttribute('aria-hidden','false');
  setTimeout(()=> forgeFill.style.width = '100%', 60);

  setTimeout(()=> {
    forging.style.display = 'none';
    forging.setAttribute('aria-hidden','true');

    finalScoreEl.textContent = score;
    finalStreakEl.textContent = longestStreak;

    overlay.classList.add('show');
    overlay.setAttribute('aria-hidden','false');
  }, 1400);
}

closeModal.addEventListener('click', ()=>{
  overlay.classList.remove('show');
  overlay.setAttribute('aria-hidden','true');
});

/* =========================
   CONFETTI (lighter)
   ========================= */
const confettiCtx = confettiCanvas.getContext('2d');
function fireConfetti(){
  const reduceMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
  if (reduceMotion) return;

  const ctx = confettiCtx;
  const w = confettiCanvas.width = window.innerWidth;
  const h = confettiCanvas.height = window.innerHeight;
  confettiCanvas.style.display = 'block';

  const pieces = [];
  const count = Math.floor(Math.min(90, w/10));
  for(let i=0;i<count;i++){
    pieces.push({
      x: Math.random()*w,
      y: Math.random()*-h*0.4,
      w: 6 + Math.random()*10,
      h: 6 + Math.random()*10,
      vx: -2 + Math.random()*4,
      vy: 2 + Math.random()*6,
      rot: Math.random()*360,
      speed: 0.02 + Math.random()*0.06,
      color: ['#2563eb','#ef4444','#10b981','#f59e0b','#7c3aed'][Math.floor(Math.random()*5)]
    });
  }

  const start = performance.now();
  function render(t){
    ctx.clearRect(0,0,w,h);
    for(let p of pieces){
      p.x += p.vx;
      p.y += p.vy;
      p.rot += p.speed*30;
      ctx.save();
      ctx.translate(p.x,p.y);
      ctx.rotate(p.rot*Math.PI/180);
      ctx.fillStyle = p.color;
      ctx.fillRect(-p.w/2,-p.h/2,p.w,p.h);
      ctx.restore();
    }
    if ((t - start) < 2000) requestAnimationFrame(render);
    else {
      confettiCanvas.style.display = 'none';
      ctx.clearRect(0,0,w,h);
    }
  }
  requestAnimationFrame(render);
}

window.addEventListener('resize', ()=> {
  if (confettiCanvas.style.display !== 'none'){
    confettiCanvas.width = window.innerWidth;
    confettiCanvas.height = window.innerHeight;
  }
});

/* =========================
   RESET / RESTART
   ========================= */
function hardReset(){
  gameLocked = false;

  attempts = 0;
  score = 0;
  streak = 0;
  longestStreak = 0;
  streakBoostApplied = false;

  attemptsEl.textContent = attempts;
  scoreEl.textContent = score;
  streakEl.textContent = streak;

  timeUpBar.style.display = 'none';
  overlay.classList.remove('show');
  forging.style.display = 'none';

  resetTimer();
  stopTracksAnimation();

  buildRound1();
  showToast('Ready! Tap any LOCK button to start.');
}

resetBtn.addEventListener('click', hardReset);
restartBtn.addEventListener('click', hardReset);

/* =========================
   ROUND 3 GLOBAL ACTION
   ========================= */
actionBtn.addEventListener('click', ()=>{
  if (gameLocked) return;
  if (round !== 3) return; // only works in round 3
  startTimerIfNeeded();

  const result = lockTargetRound3();
  if (result && result.done){
    actionBtn.disabled = true;
    setTimeout(()=> finishGame(), 650);
  }
});

/* =========================
   INIT
   ========================= */
updateTimerUI();
hardReset();
</script>
</body>
</html>
